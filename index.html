<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>version0004 + simulation-0001 (Merged)</title>
  <style>
    :root{
      --text:#ededf2;
      --muted:#b9b9c2;
      --muted2:#8e8e99;
      --line:#2a2a30;
      --line2:#3a3a42;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.4);
      --r2:18px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --c1:#5a081f;
      --c2:#063b78;
      --c3:#3a0b82;
      --c4:#067b72;

      --ballBright: 0;

      /* triangle animation state (only affects top-left triangle panel) */
      --triSX: 1;
      --triSY: 1;

      /* click after expansion makes fill fully opaque deep gray */
      --triFillA: .28;
      --triFillRGB: 10,10,12;

      /* Right drawer */
      --drawerW: 292px;
      --drawerPeek: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      overflow:hidden;

      background:
        radial-gradient(1200px 880px at 18% 14%, rgba(255,255,255,.16), rgba(255,255,255,0) 62%),
        radial-gradient(980px 720px at 82% 28%, rgba(255,255,255,.13), rgba(255,255,255,0) 58%),
        radial-gradient(980px 820px at 55% 88%, rgba(90,190,255,.16), rgba(0,0,0,0) 62%),
        radial-gradient(900px 720px at 70% 65%, rgba(255,90,170,.12), rgba(0,0,0,0) 60%),
        linear-gradient(120deg, var(--c1), var(--c2));
      animation: bgShift 10s linear infinite alternate;
    }

    @keyframes bgShift{
      0%   { background:
        radial-gradient(1200px 880px at 18% 14%, rgba(255,255,255,.16), rgba(255,255,255,0) 62%),
        radial-gradient(980px 720px at 82% 28%, rgba(255,255,255,.13), rgba(255,255,255,0) 58%),
        radial-gradient(980px 820px at 55% 88%, rgba(90,190,255,.16), rgba(0,0,0,0) 62%),
        radial-gradient(900px 720px at 70% 65%, rgba(255,90,170,.12), rgba(0,0,0,0) 60%),
        linear-gradient(120deg, var(--c1), var(--c2));
      }
      50%  { background:
        radial-gradient(1200px 880px at 24% 18%, rgba(255,255,255,.15), rgba(255,255,255,0) 62%),
        radial-gradient(980px 720px at 76% 26%, rgba(255,255,255,.12), rgba(255,255,255,0) 58%),
        radial-gradient(980px 820px at 52% 90%, rgba(190,120,255,.16), rgba(0,0,0,0) 62%),
        radial-gradient(900px 720px at 30% 70%, rgba(90,255,210,.12), rgba(0,0,0,0) 60%),
        linear-gradient(120deg, var(--c3), var(--c4));
      }
      100% { background:
        radial-gradient(1200px 880px at 16% 12%, rgba(255,255,255,.16), rgba(255,255,255,0) 62%),
        radial-gradient(980px 720px at 84% 34%, rgba(255,255,255,.13), rgba(255,255,255,0) 58%),
        radial-gradient(980px 820px at 58% 86%, rgba(120,255,220,.16), rgba(0,0,0,0) 62%),
        radial-gradient(900px 720px at 72% 68%, rgba(255,160,70,.10), rgba(0,0,0,0) 60%),
        linear-gradient(120deg, var(--c2), var(--c1));
      }
    }

    /* =========================
       Personal website canvas bg
       ========================= */
    #bg{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      filter: contrast(125%) saturate(0) brightness(135%);
      opacity:1;
    }

    /* =========================
       Personal website layout
       ========================= */
    .app{
      position:relative;
      z-index:1;
      height:100%;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }

    .topLayer{
      position:relative;
      flex:0 0 auto;
      height:160px;
      min-height:160px;
      border-radius: var(--r2);
      pointer-events:none;
    }

    .triWrap{
      position:absolute;
      left:0;
      top:0;
      width: 30%;
      height: 30%;
      min-width: 260px;
      min-height: 180px;
      max-width: 520px;
      max-height: 340px;
      pointer-events:auto;
      cursor:pointer;
      user-select:none;
      z-index: 3;
      will-change: transform, opacity;
      transform-origin: 0 0;

      transform: scaleX(var(--triSX)) scaleY(var(--triSY));
    }

    .triHit{
      position:absolute;
      inset:0;
      clip-path: polygon(0 0, 100% 0, 0 100%);

      background: rgba(var(--triFillRGB), var(--triFillA));

      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 0;
      will-change: opacity;
    }

    .triSvg{display:none;}

    .triText{
      position:absolute;
      inset:0;
      padding: 14px 16px 14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      pointer-events:none;
    }

    .triText .placeholder{
      margin-top: 6px;
      font-weight: 850;
      letter-spacing:.2px;
      font-size: 14px;
      color: rgba(255,255,255,.92);
      text-transform: lowercase;
    }

    .triText .full{
      display:none;
      margin:0;
      padding-right: 10px;
      max-width: 54ch;
    }
    .triText .full h1{
      margin:0;
      font-size:16px;
      font-weight: 900;
      letter-spacing:.2px;
      line-height:1.15;
    }
    .triText .full p{
      margin:8px 0 0;
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }

    .triWrap.enter{
      animation: triEnter 650ms linear forwards;
    }
    @keyframes triEnter{
      from{ transform: translate3d(-18px, -18px, 0) scaleX(var(--triSX)) scaleY(var(--triSY)); opacity:0; }
      to{ transform: translate3d(0,0,0) scaleX(var(--triSX)) scaleY(var(--triSY)); opacity:1; }
    }

    .triWrap.expanded{
      position:absolute;
      left:0; top:0;
      z-index:3;
      pointer-events:auto;
    }

    .triWrap.expanded .placeholder{ display:none; }
    .triWrap.expanded .full{ display:block; }

    .triWrap.expanded .triText{
      padding: 26px 26px;
      max-width: 880px;
    }
    .triWrap.expanded .triText .full h1{ font-size: 20px; }
    .triWrap.expanded .triText .full p{ font-size: 13px; }

    .triWrap.expanded .full{
      opacity:0;
      transform: translate3d(0,6px,0);
      transition: opacity 220ms linear, transform 220ms linear;
    }
    .triWrap.showIntro .full{
      opacity:1;
      transform: translate3d(0,0,0);
    }

    .navBar{
      position:absolute;
      top: 0;
      right: 0;
      width: 60%;
      height: 10%;
      min-height: 46px;
      max-height: 74px;
      min-width: 420px;
      max-width: 860px;

      background: transparent;
      border: 0;
      border-radius: 0;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;

      pointer-events:auto;
      z-index: 2;

      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding: 10px 14px;
      gap:12px;
    }

    .navRings{
      flex: 1 1 auto;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 8px;
      min-width: 0;
    }

    .navPara{
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(36,36,42,.70), rgba(16,16,18,.55));
      color: rgba(255,255,255,.92);
      height: calc(100% - 8px);
      min-height: 34px;
      padding: 0 16px;
      border-radius: 10px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      font-weight: 850;
      letter-spacing:.2px;
      text-transform: lowercase;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);

      transform: skewX(-18deg);
      transform-origin: center;
      transition: filter .15s ease, border-color .15s ease, transform .08s ease;
      white-space:nowrap;
      flex: 0 0 auto;
    }
    .navPara > span{
      transform: skewX(18deg);
      display:inline-block;
    }
    .navPara:hover{ border-color: rgba(255,255,255,.28); filter: brightness(112%); }
    .navPara:active{ transform: skewX(-18deg) translateY(1px); }

    .badges{
      position:absolute;
      right: 0;
      top: calc(10% + 10px);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      pointer-events:auto;
      z-index:2;
    }
    .badge{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      background: rgba(18,18,20,.65);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
      user-select:none;
    }

    .main{
      flex:1 1 auto;
      border:0;
      border-radius:var(--r2);
      background: linear-gradient(180deg, rgba(22,22,26,.58), rgba(14,14,16,.42));
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .mainTop{ display:none; }

    .stage{
      position:relative;
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
      contain: layout paint size style;
    }

    .ball{
      position:absolute;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(140px 140px at 30% 28%, rgba(255,255,255,.14), rgba(255,255,255,0) 55%),
        radial-gradient(180px 180px at 60% 65%, rgba(255,255,255,.07), rgba(0,0,0,0) 70%),
        linear-gradient(180deg,
          rgba(var(--ballBright, 0), var(--ballBright, 0), var(--ballBright, 0), .85),
          rgba(0,0,0,.78)
        );
      box-shadow:
        0 20px 60px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.08);

      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      cursor:pointer;
      user-select:none;

      transform: translate3d(0,0,0) scale(1);
      transform-origin: center center;
      transition: filter .12s ease, border-color .12s ease;
      will-change: transform;
      backface-visibility: hidden;
    }
    .ball:hover{border-color: rgba(255,255,255,.18);}
    .ball .label{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .ball .title{
      font-size:13px;
      font-weight:900;
      letter-spacing:.2px;
      line-height:1.15;
      max-width: 18ch;
    }
    .ball .desc{
      font-size:11px;
      color:var(--muted);
      line-height:1.25;
      max-width: 22ch;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
    }
    .ball .tiny{
      font-size:11px;
      color:var(--muted2);
      font-family: var(--mono);
    }

    .overlay{
      position:fixed;
      inset:0;
      z-index:9;
      display:none;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .overlay.show{display:block;}

    .sheet{
      position:absolute;
      inset: 14px;
      border:1px solid var(--line);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(18,18,20,.95), rgba(12,12,14,.90));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
      min-height:0;
    }
    .sheetHead{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(22,22,26,.35);
    }
    .sheetHead .left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .sheetHead .sheetTitle{
      margin:0;
      font-size:14px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .sheetHead .sheetSub{
      margin:0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 72vw;
    }
    .sheetBody{
      padding:12px;
      overflow:auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .sheet.page2Bg{
      border-color: rgba(255,255,255,.12);
      background:
        linear-gradient(180deg, rgba(10,10,12,.55), rgba(10,10,12,.78)),
        url("https://www.lilanschool.com/files/chat/2026/02-05/11003752d890809955.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    .sheet.page2Bg .sheetBody{
      background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.46));
    }

    .panel{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(12,12,14,.35);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .panelTitle{
      font-size:13px;
      font-weight:900;
      margin:0;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .mono{font-family:var(--mono);}

    label{font-size:12px; color:var(--muted);}
    input[type="text"], textarea{
      width:100%;
      border:1px solid var(--line2);
      background: rgba(10,10,12,.55);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:13px;
      transition: border-color .15s ease, background .15s ease;
    }
    textarea{
      min-height: 140px;
      resize: vertical;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.45;
    }
    input:focus, textarea:focus{border-color:#6d6d78; background: rgba(12,12,14,.7)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .col{display:flex; flex-direction:column; gap:6px}
    .hr{height:1px; background: var(--line); margin:2px 0}

    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 980px){
      body{overflow:auto}
      .main{min-height: 780px;}
      .stage{min-height: 720px;}
      .cards{grid-template-columns: 1fr;}
      .navBar{min-width: 320px;}
      .triWrap{min-width: 220px; min-height: 160px;}
    }
    .card{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      background: rgba(10,10,12,.45);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card h4{
      margin:0;
      font-size:13px;
      font-weight:900;
    }
    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 10px;
      align-items:start;
      font-size:12px;
      color: var(--muted);
    }
    .kv b{color: var(--text); font-weight:800}
    .link{
      color: var(--text);
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,.25);
      text-underline-offset: 2px;
    }

    .cvBox{
      border:1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      background: rgba(10,10,12,.35);
      padding:12px;
    }

    dialog{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(18,18,20,.96);
      color:var(--text);
      max-width:720px;
      width:calc(100vw - 28px);
      box-shadow: var(--shadow);
    }
    .dlgHead{
      padding: 14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .dlgBody{
      padding: 14px;
      color: var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .dlgActions{
      padding: 0 14px 14px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    /* CLUB PAGE */
    .clubWrap{
      position:relative;
      min-height: 100%;
      display:grid;
      grid-template-columns: minmax(320px, 1fr) minmax(360px, 1.05fr);
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .clubWrap{ grid-template-columns: 1fr; }
    }

    .clubText{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(10,10,12,.45);
      padding: 14px;
      box-shadow: 0 16px 50px rgba(0,0,0,.28);
      height: fit-content;
    }
    .clubText h3{
      margin:0 0 8px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .clubText p{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }

    .clubGallery{
      position:relative;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(10,10,12,.30);
      overflow:hidden;
      min-height: 540px;
      max-height: calc(100vh - 220px);
      box-shadow: 0 16px 50px rgba(0,0,0,.28);
      display:flex;
      flex-direction:column;
    }
    @media (max-width: 980px){
      .clubGallery{ max-height: none; }
    }

    .clubScroll{
      position:absolute;
      inset:0;
      overflow:auto;
      padding: 16px 16px 22px;
      scroll-behavior: auto;
      -webkit-overflow-scrolling: touch;

      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .clubScroll::-webkit-scrollbar{ width:0; height:0; }

    .clubScroll::before,
    .clubScroll::after{
      content:"";
      position:sticky;
      left:0; right:0;
      height: 70px;
      pointer-events:none;
      z-index: 50;
      display:block;
    }
    .clubScroll::before{
      top:0;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
      margin-top:-16px;
    }
    .clubScroll::after{
      bottom:0;
      background: linear-gradient(0deg, rgba(0,0,0,.55), rgba(0,0,0,0));
      margin-bottom:-22px;
    }

    .clubRail{
      position:relative;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .clubShot{
      position:relative;
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      box-shadow: 0 18px 46px rgba(0,0,0,.42);
    }

    .clubShot img{
      display:block;
      width:100%;
      height:auto;
      object-fit: contain;
      background: rgba(0,0,0,.25);
      filter: none;
    }

    .clubMeta{
      position:absolute;
      left: 12px;
      bottom: 10px;
      right: 12px;
      font-size: 11px;
      color: rgba(255,255,255,.84);
      text-shadow: 0 10px 28px rgba(0,0,0,.65);
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
      user-select:none;
    }
    .clubMeta .tag{
      color: rgba(255,255,255,.72);
      font-family: var(--mono);
    }

    /* Right drawer */
    .rightDock{
      position:fixed;
      top: 50%;
      right: 0;
      transform: translate3d(0,-50%,0);
      z-index: 12;
      display:flex;
      align-items:stretch;
      pointer-events:none;
    }
    .rightDock:not(.open) .dockArrow{
      position:fixed;
      top: 50%;
      right: 0;
      transform: translate3d(0,-50%,0);
    }
    .rightDock.open .dockArrow{
      position:static;
      transform: none;
    }

    .dockArrow{
      pointer-events:auto;
      width: 44px;
      height: 56px;
      border:1px solid rgba(255,255,255,.16);
      border-right:0;
      border-radius: 14px 0 0 14px;
      background: linear-gradient(180deg, rgba(36,36,42,.85), rgba(16,16,18,.70));
      box-shadow: 0 12px 28px rgba(0,0,0,.38);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: filter .15s ease, transform .08s ease, border-color .15s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 13;
    }
    .dockArrow:hover{ border-color: rgba(255,255,255,.28); filter:brightness(112%); }
    .dockArrow:active{ transform: translate3d(0,-50%,0) translateX(-1px); }

    .dockChevron{
      width: 0; height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 10px solid rgba(255,255,255,.88);
      transform: translateX(2px);
      transition: transform .18s linear;
      opacity:.92;
    }
    .rightDock.open .dockChevron{
      transform: translateX(-2px) rotate(180deg);
    }

    .dockPanel{
      pointer-events:auto;
      width: var(--drawerW);
      max-width: calc(100vw - 58px);
      border:1px solid rgba(255,255,255,.12);
      border-right:0;
      border-radius: 16px 0 0 16px;
      background: linear-gradient(180deg, rgba(18,18,20,.86), rgba(12,12,14,.78));
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;

      transform: translateX(calc(100% - var(--drawerPeek)));
      opacity: .98;
      transition: transform 220ms linear;
    }
    .rightDock.open .dockPanel{
      transform: translateX(0);
    }

    .dockInner{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }
    .dockHint{
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
    }
    .dockTools{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--line2);
      background: linear-gradient(180deg, rgba(36,36,42,.9), rgba(20,20,23,.9));
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      font-size:13px;
      transition: transform .05s ease, border-color .15s ease, filter .15s ease;
    }
    .btn:hover{border-color:#73737f; filter:brightness(110%)}
    .btn:active{transform: translateY(1px)}
    .btn.ghost{background: rgba(16,16,18,.55)}
    .btn.danger{
      border-color:#55555e;
      background: linear-gradient(180deg, rgba(35,35,38,.9), rgba(16,16,18,.9));
    }

    /* =========================
       Simulator page container
       ========================= */
    #simulatorRoot{
      position: fixed;
      inset: 0;
      display: none;     /* shown when entering simulator */
      background: #000;
      z-index: 100;
    }
    #simulatorRoot.active{ display:block; }

    #simulatorRoot canvas{
      display:block;
      width:100vw;
      height:100vh;
    }

    /* Simulator UI */
    #simUI{
      position: absolute;
      inset: 0;
      pointer-events: none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
    }

    #simTopLeft{
      position: fixed;
      left: 14px;
      top: 12px;
      z-index: 110;
      display:flex;
      gap:10px;
      pointer-events: auto;
    }
    #simTopLeft button{
      appearance:none; border:1px solid rgba(255,255,255,0.35);
      background: rgba(20,20,20,0.35);
      color:#fff; padding:10px 14px; border-radius:10px;
      cursor:pointer; backdrop-filter: blur(6px);
      font-size:14px;
    }
    #simTopLeft button:hover { background: rgba(20,20,20,0.55); }

    #simBottomLeft{
      position: fixed; left: 14px; bottom: 14px; z-index: 110;
      width: 340px; max-width: calc(100vw - 28px);
      color: #fff;
      background: rgba(20,20,20,0.35);
      border:1px solid rgba(255,255,255,0.25);
      border-radius: 12px;
      padding: 12px 12px 10px;
      backdrop-filter: blur(6px);
      user-select:none;
      pointer-events: auto;
    }
    #simBottomLeft .row { display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0; }
    #simBottomLeft .label { font-size:13px; opacity:0.95; }
    #simBottomLeft input[type="range"]{ width: 190px; }
    #simBottomLeft .val { width: 90px; text-align:right; font-variant-numeric: tabular-nums; opacity:0.95; font-size:13px; }

    #simBottomLeft .hint{
      margin-top: 8px;
      font-size: 12px;
      line-height: 1.35;
      opacity: 0.9;
    }
    #simBottomLeft .hud{
      margin-top: 8px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
      font-size: 12px;
      opacity: 0.95;
      font-variant-numeric: tabular-nums;
    }
    #simBottomLeft .k{ opacity:0.85; }
    #simBottomLeft .v{ text-align:right; }

    /* Back button */
    #btnBackToSite{
      position: fixed;
      right: 14px;
      top: 12px;
      z-index: 110;
      pointer-events: auto;
      appearance:none;
      border:1px solid rgba(255,255,255,0.35);
      background: rgba(20,20,20,0.35);
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      backdrop-filter: blur(6px);
      font-size:14px;
    }
    #btnBackToSite:hover{ background: rgba(20,20,20,0.55); }
  </style>
</head>

<body>
  <!-- Personal website -->
  <canvas id="bg"></canvas>

  <div class="app" id="siteRoot">
    <div class="topLayer">
      <div class="triWrap enter" id="triWrap" aria-label="self introduction">
        <div class="triHit" id="triHit"></div>

        <svg class="triSvg" id="triSvg" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
          <line id="triLine"
                x1="0" y1="100" x2="100" y2="0"
                stroke="rgba(255,255,255,.95)"
                stroke-width="1"
                vector-effect="non-scaling-stroke"/>
        </svg>

        <div class="triText">
          <div class="placeholder" id="triPlaceholder">self introduction</div>
          <div class="full" id="triFull">
            <h1 id="heroTitle">L — Autonomous Systems Applicant</h1>
            <p id="heroSub">Impact-driven: I want to help unlock the low-altitude economy through autonomous UAV systems, and improve productivity with AI so people can spend more time exploring and creating.</p>
          </div>
        </div>
      </div>

      <div class="navBar" id="navBar" aria-label="Navigation">
        <div class="navRings" id="navRings">
          <button class="navPara" id="navClub" type="button"><span>club</span></button>
          <!-- Change: second item renamed to simulator -->
          <button class="navPara" id="navSimulator" type="button"><span>simulator</span></button>
          <button class="navPara" id="navPara3" type="button"><span>page3</span></button>
          <button class="navPara" id="navPara4" type="button"><span>page4</span></button>
        </div>
      </div>

      <div class="badges">
        <span class="badge" id="saveBadge">Saved</span>
        <span class="badge" id="storeBadge">Storage: checking…</span>
        <span class="badge" id="langBadge">EN</span>
      </div>
    </div>

    <section class="main">
      <div class="mainTop"></div>
      <div class="stage" id="stage"></div>
    </section>
  </div>

  <!-- Right-side arrow + expandable drawer (persistent) -->
  <div class="rightDock" id="rightDock" aria-label="Tools drawer">
    <button class="dockArrow" id="dockArrow" type="button" aria-label="Toggle tools">
      <span class="dockChevron" aria-hidden="true"></span>
    </button>
    <div class="dockPanel" id="dockPanel" aria-hidden="true">
      <div class="dockInner">
        <div class="dockHint" id="dockHint">
          Hover interaction: near → spheres move closer, brighten & scale up; far → move away, darken & scale down. No overlap; max displacement ≤ 10%.
        </div>
        <div class="dockTools">
          <button class="btn ghost" id="btnLangDock" type="button">中文</button>
          <button class="btn ghost" id="btnDownloadTextDock" type="button">Download Text</button>
          <button class="btn ghost" id="btnExportJSONDock" type="button">Export JSON</button>
          <label class="btn ghost" for="importJSONDock" style="cursor:pointer">
            Import JSON
            <input id="importJSONDock" type="file" accept="application/json" style="display:none" />
          </label>
          <button class="btn danger ghost" id="btnClearAllDock" type="button">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="sheet" id="sheet" role="dialog" aria-modal="true">
      <div class="sheetHead">
        <div class="left">
          <h2 class="sheetTitle" id="sheetTitle">Title</h2>
          <p class="sheetSub" id="sheetSub">Subtitle</p>
        </div>
        <div class="row">
          <button class="btn ghost" id="btnCloseSheet" type="button">Close</button>
        </div>
      </div>
      <div class="sheetBody" id="sheetBody"></div>
    </div>
  </div>

  <dialog id="confirmDlg">
    <div class="dlgHead">
      <div style="font-weight:900" id="confirmTitle">Confirm</div>
      <div></div>
    </div>
    <div class="dlgBody" id="confirmBody"></div>
    <div class="dlgActions">
      <button class="btn ghost" id="confirmNo" type="button">Cancel</button>
      <button class="btn" id="confirmYes" type="button">OK</button>
    </div>
  </dialog>

  <!-- Simulator root (simulation-0001) -->
  <div id="simulatorRoot" aria-hidden="true">
    <div id="simUI">
      <div id="simTopLeft">
        <button id="btnStart">开始</button>
        <button id="btnRestart">重新开始</button>
      </div>

      <button id="btnBackToSite" type="button">返回</button>

      <div id="simBottomLeft">
        <div class="row">
          <div class="label">升力系数 (Cl)</div>
          <input id="lift" type="range" min="0.6" max="2.4" step="0.01" value="1.35" />
          <div class="val" id="liftVal">1.35</div>
        </div>
        <div class="row">
          <div class="label">阻力系数 (Cd)</div>
          <input id="drag" type="range" min="0.01" max="0.25" step="0.001" value="0.06" />
          <div class="val" id="dragVal">0.060</div>
        </div>

        <div class="row">
          <div class="label">风力 (m/s)</div>
          <input id="windSpeed" type="range" min="0" max="10" step="0.1" value="0" />
          <div class="val" id="windSpeedVal">0.0</div>
        </div>
        <div class="row">
          <div class="label">风向 (°)</div>
          <input id="windDir" type="range" min="0" max="360" step="1" value="0" />
          <div class="val" id="windDirVal">0</div>
        </div>

        <div class="hud">
          <div class="k">油门</div><div class="v" id="hudThrottle">0.00</div>
          <div class="k">空速 (m/s)</div><div class="v" id="hudSpeed">0.0</div>
          <div class="k">高度 (m)</div><div class="v" id="hudAlt">0.0</div>
          <div class="k">迎角AoA (°)</div><div class="v" id="hudAoA">0.0</div>
        </div>

        <div class="hint">
          键位：Shift 油门+（线性变化）｜Ctrl 油门- ｜W 低头｜S 抬头｜A 左偏航｜D 右偏航｜Q 左滚转｜E 右滚转<br/>
          说明：控制输入无额外延迟，非线性爬升到最大角速度（约 1s/180°）。
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // Always block keyboard defaults (as required)
  window.addEventListener('keydown', (e) => { e.preventDefault(); }, {capture:true, passive:false});

  const $ = (sel, el=document) => el.querySelector(sel);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const lerp  = (a,b,t) => a + (b-a)*t;
  const nonlinear2 = (t) => t*t;

  function escapeHtml(s){
    return (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function formatBytes(bytes){
    if(typeof bytes !== 'number' || !isFinite(bytes)) return '-';
    const u = ['B','KB','MB','GB','TB'];
    let i = 0, n = bytes;
    while(n >= 1024 && i < u.length-1){ n/=1024; i++; }
    return (i===0 ? n.toFixed(0) : n.toFixed(1)) + ' ' + u[i];
  }

  const LS_KEY = 'L_admissions_site_v1';
  const DEFAULT_FORM_EMBED_URL = 'https://docs.google.com/forms/d/e/PLACEHOLDER/viewform?embedded=true';
  const DEFAULT_YT_URL = 'https://www.youtube.com/';

  let model = {
    version: 1,
    lang: 'en',
    content: {
      en: {
        heroTitle: 'L — Autonomous Systems Applicant',
        heroSub: 'Impact-driven: I want to help unlock the low-altitude economy through autonomous UAV systems, and improve productivity with AI so people can spend more time exploring and creating.',
        topHint: 'Hover interaction: near → spheres move closer, brighten & scale up; far → move away, darken & scale down. No overlap; max displacement ≤ 10%.',
        spheres: {
          home:   {title:'Home', desc:'Your one-line highlight & site overview', tiny:''},
          about:  {title:'About', desc:'Applicant profile, strengths & motivation', tiny:''},
          projects:{title:'Projects', desc:'Roadmap: “Autonomous UAV Mission”', tiny:''},
          pubs:   {title:'Publications', desc:'Papers & reports (in progress)', tiny:''},
          contact:{title:'Contact', desc:'Email + leave a message (Form)', tiny:''},
          cv:     {title:'CV', desc:'Web CV now; PDF coming soon', tiny:''},
          edit:   {title:'Edit', desc:'Edit all texts & links (saved locally)', tiny:'LOCAL'},
        },
        sections: {
          home: {
            headline: 'Highlight',
            highlight: 'I am impact-driven and execution-oriented: I turn goals into tangible outcomes while staying focused on real-world value.',
            focusTitle: 'Focus',
            focusBody: 'Autonomous UAV missions, flight control & navigation foundations, and building toward task-level autonomy for practical deployments.',
            orderHint: 'Admissions-friendly flow: highlight → roadmap → demo video.',
          },
          about: {
            title: 'About',
            body:
`I’m L, an undergraduate student passionate about aerospace and autonomous systems. My long-term goal is to become a researcher focused on autonomous UAV missions—building systems that can reliably take off, follow waypoints, and land safely, and ultimately scale toward task-level autonomy. What motivates me most is impact: I’m excited by how UAV autonomy can contribute to the low-altitude economy, and how AI can improve productivity so people can spend more time on exploration and creation.

I value self-driven learning and practical execution. In the past semester, I maintained a consistent learning routine for Python (3 days per week, at least 1 hour per day) and reached object-oriented programming and class-based design. Beyond technical learning, I also strengthened my organizational and communication skills by revitalizing an inactive student club—growing membership to 30 and successfully hosting its first official event. This experience taught me how to communicate clearly, coordinate participants, and turn ideas into outcomes.

I am preparing to apply for an MSc in Robotics / Autonomous Systems. I hope to develop solid foundations in flight control, navigation, and autonomy through structured coursework and hands-on projects, and to contribute to research and engineering teams working on real-world UAV autonomy.`
          },
          projects: {
            title: 'Projects (Roadmap)',
            mainProjectTitle: 'Autonomous UAV Mission: From Navigation to Task-level Autonomy',
            goal: 'Simulation demo: auto takeoff → waypoint navigation → auto landing.',
            method: 'Start with a minimal reproducible pipeline, then gradually improve robustness and autonomy.',
            milestones: [
              {when:'Now', what:'Set up simulation environment; document baseline pipeline; define evaluation checklist.'},
              {when:'Next (1–2 months)', what:'Implement waypoint mission; tune stability; produce a clean demo video.'},
              {when:'Later (3–6 months)', what:'Extend to reliability improvements (disturbance handling, safety checks) and clearer evaluation.'}
            ],
            demoTitle: 'Demo Video (YouTube)',
            demoUrl: DEFAULT_YT_URL
          },
          pubs: {
            title: 'Publications',
            body: 'No publications yet. (In preparation) — I am building foundations and documenting a project roadmap toward autonomous UAV missions.'
          },
          contact: {
            title: 'Contact',
            emailLabel: 'Email',
            emailValue: 'your_outlook@example.com',
            messageTitle: 'Leave a message',
            messageHint: 'Feel free to leave a message — I will reply by email within 48 hours.',
            formEmbedUrl: DEFAULT_FORM_EMBED_URL
          },
          cv: {
            title: 'CV',
            body: 'Web CV is included here. PDF version: Coming soon.',
            bullets: [
              'Education: (edit this)',
              'Skills: Python (OOP), learning autonomy & control foundations (edit this)',
              'Leadership: grew a student club to 30 members; hosted first official event (edit this)'
            ]
          },
          edit: {
            title: 'Edit Content',
            sub: 'All site content is editable here and saved to localStorage. Export/Import JSON for backup or moving computers.',
            note: 'Tip: Replace the Google Form embed URL and YouTube demo URL when ready.'
          }
        }
      },
      zh: {
        heroTitle: 'L — 个人申请网站（自主系统）',
        heroSub: '影响力导向：希望通过无人机自主系统推动低空经济，并用 AI 提升生产力，让人类有更多时间探索与创造。',
        topHint: '鼠标交互：靠近→球靠近鼠标、变亮变大；远离→远离鼠标、变黑变小；球不重叠，位移≤10%。',
        spheres: {
          home:   {title:'首页', desc:'闪光点一句话 + 网站概览', tiny:''},
          about:  {title:'关于我', desc:'个人简介 / 能力证明 / 动机', tiny:''},
          projects:{title:'项目路线图', desc:'主项目：无人机自主任务路线', tiny:''},
          pubs:   {title:'论文与报告', desc:'（筹备中）', tiny:''},
          contact:{title:'联系我', desc:'邮箱 + 留言表单', tiny:''},
          cv:     {title:'简历', desc:'网页版简历；PDF 之后补', tiny:''},
          edit:   {title:'编辑', desc:'编辑所有文字与链接（本地保存）', tiny:'LOCAL'},
        },
        sections: {
          home: {
            headline: '我的闪光点',
            highlight: '我更关注真实价值与影响力：愿意把目标落实成可展示的结果，同时保持长期方向不偏航。',
            focusTitle: '方向',
            focusBody: '无人机自主飞行（从飞控/导航基础到任务级自主），面向实际应用场景与可演示成果。',
            orderHint: '申请向结构：闪光点 → 路线图 → 演示视频。',
          },
          about: {
            title: '关于我',
            body:
`我叫 L，本科阶段对航空航天与自主系统方向非常感兴趣。我的长期目标是成为研究员，聚焦无人机自主任务：先做出可复现的基础闭环（自动起飞→航点→自动降落），再逐步走向任务级自主。驱动我持续投入的，是影响力：我相信无人机自主能够推动低空经济，也相信 AI 能提升生产力，让人类把时间更多投入探索与创造。

我具有较强的自驱与执行力。上一个学期我保持稳定的 Python 学习节奏（每周 3 天、每天至少 1 小时），学习并掌握了类/面向对象等内容。同时，我也注重组织与沟通能力：我推动一个不活跃社团完成转正，担任活动部长，社员增长至 30 人，并成功举办了第一次社团活动。这段经历让我学会更清晰地沟通、协调参与者，并把事情真正做成。

我计划申请 Robotics / Autonomous Systems 方向硕士，并希望在飞控、导航与自主等方面打牢基础，通过持续的项目迭代与成果展示，逐步形成研究与工程能力。`
          },
          projects: {
            title: '项目路线图（主项目）',
            mainProjectTitle: 'Autonomous UAV Mission: From Navigation to Task-level Autonomy',
            goal: '仿真演示：自动起飞 → 航点飞行 → 自动降落。',
            method: '先跑通最小闭环，再逐步提升稳定性与可复现性。',
            milestones: [
              {when:'现在', what:'搭建仿真环境；整理最小闭环流程；制定评估清单。'},
              {when:'未来 1–2 个月', what:'实现稳定航点任务；输出清晰演示视频。'},
              {when:'未来 3–6 个月', what:'提高可靠性（抗扰/安全检查等），并补充更清晰的评估与复盘。'}
            ],
            demoTitle: '演示视频（YouTube）',
            demoUrl: DEFAULT_YT_URL
          },
          pubs: {
            title: '论文与报告',
            body: '目前暂无论文（筹备中）。我正在通过项目路线图与持续输出，逐步积累研究与工程能力。'
          },
          contact: {
            title: '联系我',
            emailLabel: '邮箱',
            emailValue: 'your_outlook@example.com',
            messageTitle: '留言',
            messageHint: '欢迎留言，我会在 48 小时内通过邮箱回复。',
            formEmbedUrl: DEFAULT_FORM_EMBED_URL
          },
          cv: {
            title: '简历（网页）',
            body: '先提供网页版简历。PDF 版本：后续补充。',
            bullets: [
              '教育经历：（可编辑）',
              '技能：Python（面向对象）；正在学习无人机自主与控制基础（可编辑）',
              '经历：社员增长至 30；举办第一次社团活动；活动部长（可编辑）'
            ]
          },
          edit: {
            title: '编辑网站内容',
            sub: '这里可以编辑网站所有文字与链接，并自动保存到本地。可导出/导入 JSON 备份或换电脑。',
            note: '提示：后续替换 Google 表单嵌入链接与 YouTube 视频链接即可。'
          }
        }
      }
    },
    updatedAt: Date.now()
  };

  const els = {
    bg: $('#bg'),
    stage: $('#stage'),
    overlay: $('#overlay'),
    sheet: $('#sheet'),
    sheetTitle: $('#sheetTitle'),
    sheetSub: $('#sheetSub'),
    sheetBody: $('#sheetBody'),
    btnCloseSheet: $('#btnCloseSheet'),

    saveBadge: $('#saveBadge'),
    storeBadge: $('#storeBadge'),
    langBadge: $('#langBadge'),

    heroTitle: $('#heroTitle'),
    heroSub: $('#heroSub'),
    topHint: $('#topHint'), // (kept in JS logic, although hidden in DOM in original; here removed)

    rightDock: $('#rightDock'),
    dockArrow: $('#dockArrow'),
    dockPanel: $('#dockPanel'),
    dockHint: $('#dockHint'),
    btnLangDock: $('#btnLangDock'),
    btnDownloadTextDock: $('#btnDownloadTextDock'),
    btnExportJSONDock: $('#btnExportJSONDock'),
    importJSONDock: $('#importJSONDock'),
    btnClearAllDock: $('#btnClearAllDock'),

    confirmDlg: $('#confirmDlg'),
    confirmTitle: $('#confirmTitle'),
    confirmBody: $('#confirmBody'),
    confirmNo: $('#confirmNo'),
    confirmYes: $('#confirmYes'),

    triWrap: $('#triWrap'),
    triHit: $('#triHit'),

    navClub: $('#navClub'),
    navSimulator: $('#navSimulator'),
    navPara3: $('#navPara3'),
    navPara4: $('#navPara4'),

    // roots
    siteRoot: $('#siteRoot'),
    simulatorRoot: $('#simulatorRoot'),
    btnBackToSite: $('#btnBackToSite'),
  };

  // Track current opened sheet key
  let activeSheetKey = null;

  function rerenderActiveSheet(){
    if(!els.overlay.classList.contains('show')) return;
    if(!activeSheetKey) return;

    const k = activeSheetKey;
    if(k === 'home') return openHome();
    if(k === 'about') return openAbout();
    if(k === 'projects') return openProjects();
    if(k === 'pubs') return openPubs();
    if(k === 'contact') return openContact();
    if(k === 'cv') return openCV();
    if(k === 'edit') return openEditor();
    if(k === 'club') return openClub();
    if(k === 'p3') return openNavPage('p3');
    if(k === 'p4') return openNavPage('p4');
  }

  // Dock open state
  let dockOpen = false;
  function setDockOpen(open){
    dockOpen = !!open;
    if(dockOpen){
      els.rightDock.classList.add('open');
      els.dockPanel.setAttribute('aria-hidden','false');
    }else{
      els.rightDock.classList.remove('open');
      els.dockPanel.setAttribute('aria-hidden','true');
    }
  }
  els.dockArrow.addEventListener('click', (e) => {
    e.preventDefault();
    setDockOpen(!dockOpen);
  });

  let saveTimer = null;
  function setSaveBadge(text){ els.saveBadge.textContent = text; }
  function scheduleSave(){
    setSaveBadge(model.lang === 'zh' ? '保存中…' : 'Saving…');
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveNow, 220);
  }
  function saveNow(){
    model.updatedAt = Date.now();
    try{
      localStorage.setItem(LS_KEY, JSON.stringify(model));
      setSaveBadge(model.lang === 'zh' ? '已保存' : 'Saved');
    }catch(e){
      setSaveBadge(model.lang === 'zh' ? '保存失败' : 'Save failed');
    }
    refreshStorageBadge();
    refreshSphereLabels();
  }
  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== 'object') return;
      model = {
        ...model,
        ...obj,
        content: {
          en: {...model.content.en, ...(obj.content && obj.content.en ? obj.content.en : {})},
          zh: {...model.content.zh, ...(obj.content && obj.content.zh ? obj.content.zh : {})},
        }
      };
      if(obj.lang === 'en' || obj.lang === 'zh') model.lang = obj.lang;
    }catch(e){}
  }

  async function refreshStorageBadge(){
    if(!navigator.storage || !navigator.storage.estimate){
      els.storeBadge.textContent = model.lang === 'zh' ? '存储：未知' : 'Storage: unknown';
      return;
    }
    try{
      const est = await navigator.storage.estimate();
      els.storeBadge.textContent = (model.lang === 'zh' ? '存储：' : 'Storage: ')
        + formatBytes(est.usage || 0) + ' / ' + formatBytes(est.quota || 0);
    }catch(e){
      els.storeBadge.textContent = model.lang === 'zh' ? '存储：未知' : 'Storage: unknown';
    }
  }

  function showSheet(title, sub, bodyBuilder){
    els.sheetTitle.textContent = title;
    els.sheetSub.textContent = sub;
    els.sheetBody.innerHTML = '';
    bodyBuilder(els.sheetBody);
    els.overlay.classList.add('show');
    els.overlay.setAttribute('aria-hidden', 'false');
  }
  function closeSheet(){
    els.overlay.classList.remove('show');
    els.overlay.setAttribute('aria-hidden', 'true');
    els.sheetBody.innerHTML = '';
    activeSheetKey = null;
    stopClubAutoScroll();
  }
  els.btnCloseSheet.addEventListener('click', closeSheet);
  els.overlay.addEventListener('click', (e) => { if(e.target === els.overlay) closeSheet(); });

  function confirmLike(title, message){
    els.confirmTitle.textContent = title;
    els.confirmBody.textContent = message;
    return new Promise((resolve) => {
      let done = false;
      const finish = (v) => {
        if(done) return;
        done = true;
        els.confirmDlg.close();
        cleanup();
        resolve(v);
      };
      const onNo = () => finish(false);
      const onYes = () => finish(true);
      const cleanup = () => {
        els.confirmNo.removeEventListener('click', onNo);
        els.confirmYes.removeEventListener('click', onYes);
      };
      els.confirmNo.addEventListener('click', onNo);
      els.confirmYes.addEventListener('click', onYes);
      els.confirmDlg.showModal();
    });
  }

  function t(){ return model.content[model.lang]; }
  function applyLangToUI(){
    const c = t();
    els.heroTitle.textContent = c.heroTitle;
    els.heroSub.textContent = c.heroSub;

    els.dockHint.textContent = c.topHint;

    els.langBadge.textContent = model.lang.toUpperCase();

    els.btnLangDock.textContent = model.lang === 'en' ? '中文' : 'EN';
    els.btnDownloadTextDock.textContent = model.lang === 'en' ? 'Download Text' : '下载文字';
    els.btnExportJSONDock.textContent = model.lang === 'en' ? 'Export JSON' : '导出JSON';
    els.btnClearAllDock.textContent = model.lang === 'en' ? 'Clear' : '清空';

    setSaveBadge(model.lang === 'zh' ? '已保存' : 'Saved');
    rerenderActiveSheet();
  }
  function toggleLang(){
    model.lang = (model.lang === 'en') ? 'zh' : 'en';
    scheduleSave();
    applyLangToUI();
    rebuildSpheres();
  }

  /* Triangle scaling */
  let triState = 'collapsed';
  const triAnim = { raf: 0, start: 0, dur: 320 };

  function setTriVars(sx, sy, fillA, fillRGB){
    document.documentElement.style.setProperty('--triSX', String(sx));
    document.documentElement.style.setProperty('--triSY', String(sy));
    if(typeof fillA === 'number') document.documentElement.style.setProperty('--triFillA', String(fillA));
    if(fillRGB) document.documentElement.style.setProperty('--triFillRGB', fillRGB);
  }
  function getTriVars(){
    const cs = getComputedStyle(document.documentElement);
    return {
      sx: parseFloat(cs.getPropertyValue('--triSX')) || 1,
      sy: parseFloat(cs.getPropertyValue('--triSY')) || 1,
      a:  parseFloat(cs.getPropertyValue('--triFillA')) || 0.28,
      rgb: (cs.getPropertyValue('--triFillRGB') || '10,10,12').trim()
    };
  }
  function computeTriTargetScales(){
    const rect = els.triWrap.getBoundingClientRect();
    const baseW = Math.max(1, rect.width);
    const baseH = Math.max(1, rect.height);
    const maxSX = clamp(innerWidth / baseW, 1, 6);
    const maxSY = clamp(innerHeight / baseH, 1, 6);
    return {sx: maxSX, sy: maxSY};
  }
  function stopTriAnim(){
    if(triAnim.raf) cancelAnimationFrame(triAnim.raf);
    triAnim.raf = 0;
  }
  function animateTri(from, to, onDone){
    stopTriAnim();
    triAnim.start = performance.now();

    els.triWrap.classList.add('expanded');
    els.triWrap.classList.remove('showIntro');

    const step = (now) => {
      const tt = clamp((now - triAnim.start) / triAnim.dur, 0, 1);
      const sx = lerp(from.sx, to.sx, tt);
      const sy = lerp(from.sy, to.sy, tt);
      const a  = lerp(from.a,  to.a,  tt);
      setTriVars(sx, sy, a, to.rgb || from.rgb);

      if(tt < 1){
        triAnim.raf = requestAnimationFrame(step);
      }else{
        triAnim.raf = 0;
        onDone && onDone();
      }
    };
    triAnim.raf = requestAnimationFrame(step);
  }
  function expandTriangle(){
    if(triState !== 'collapsed') return;
    triState = 'anim';
    closeSheet();

    const current = getTriVars();
    const targetScale = computeTriTargetScales();
    const target = {sx: targetScale.sx, sy: targetScale.sy, a: 1.0, rgb: '10,10,12'};

    animateTri(current, target, () => {
      els.triWrap.classList.add('showIntro');
      triState = 'expanded';
    });
  }
  function collapseTriangle(){
    if(triState !== 'expanded') return;
    triState = 'anim';

    const current = getTriVars();
    const target = {sx: 1, sy: 1, a: 0.28, rgb: '10,10,12'};
    els.triWrap.classList.remove('showIntro');

    animateTri(current, target, () => {
      els.triWrap.classList.remove('expanded');
      triState = 'collapsed';
    });
  }
  els.triWrap.addEventListener('click', (e) => {
    e.preventDefault();
    if(triState === 'collapsed') expandTriangle();
    else if(triState === 'expanded') collapseTriangle();
  });

  /* CLUB PAGE */
  const CLUB_IMAGES = [
    "https://www.lilanschool.com/files/chat/2026/02-06/105539bbf712191048.jpg",
    "https://www.lilanschool.com/files/chat/2026/02-06/105539b97226679543.jpg",
    "https://www.lilanschool.com/files/chat/2026/02-06/105539bc197b430133.png"
  ];

  const CLUB_TEXT_EN =
`I helped revive a previously quiet aviation club by rebuilding its visibility and engagement from the ground up. To bring members back and attract new enthusiasts, I launched a consistent WeChat publicity plan: clear event posters, short write-ups on aviation topics, highlights from member contributions, and regular updates that made the club feel active, welcoming, and worth joining. This steady communication created momentum and encouraged people who were interested in aviation—but hesitant to participate—to take the first step.

To support the club’s long-term recovery, I took on the role of Director of Activities and worked closely with the club president to restructure our planning process. We clarified responsibilities, set a realistic event calendar, and focused on activities that were both accessible to beginners and meaningful for experienced members. Instead of relying on one-off events, we aimed to build a rhythm of participation and a stronger sense of community.

One of our key initiatives was an aviation photography outing at Shanghai Hongqiao International Airport. I coordinated the schedule, location selection, and on-site organization, ensuring members could practice spotting and photographing aircraft in a structured but relaxed setting. The event gave members a shared experience, plenty of discussion topics, and a tangible reason to stay involved.

Beyond formal activities, I also introduced aviation culture in everyday life. I shared my flight simulation setup and invited new dormmates to try it firsthand, guiding them through basic procedures and controls. This informal hands-on experience sparked curiosity and helped convert casual interest into genuine enthusiasm.

Most importantly, I reached out to a currently active pilot and established a strong connection. The pilot is now collaborating closely with our club, providing professional insight and helping us develop more credible, inspiring content and future events.`;

  const CLUB_TEXT_ZH =
`我通过从零重建社团的曝光与参与感，帮助一个原本沉寂的航协逐步“活”起来。为了召回老成员、吸引新同学，我制定并执行了稳定的微信公众号宣传计划：包括清晰的活动海报、简短的航空知识科普、成员内容展示以及固定频率的更新。持续的输出让社团呈现出“在认真做事”的状态，也降低了观望同学迈出第一步的心理门槛。

为了社团的长期恢复，我担任活动部长，并与社长协作梳理活动规划流程：明确分工、制定可执行的活动节奏，优先选择对新手友好、同时也能让老成员觉得“有内容”的活动。我们不再依赖一次性的热闹，而是努力形成可持续参与的社群氛围。

其中一次关键活动是组织虹桥机场的航空摄影外拍。我负责时间安排、机位选择与现场组织，让成员能够在相对结构化、但又轻松的氛围中进行拍摄与交流。这次活动带来了共同体验与讨论话题，也增强了成员持续参与的意愿。

除了正式活动，我也把航空文化带进日常生活。我展示了自己的飞行模拟设备，并邀请新室友亲自体验，带他们完成最基础的操作与流程。这种轻量的动手体验往往更容易激发兴趣，把“随便看看”转化为“真正想了解”。

更重要的是，我主动联系到一位正在飞行的现役飞行员，并建立了稳定连接。目前这位飞行员已与社团开展深度合作，提供专业视角，帮助我们产出更有可信度、更具吸引力的内容与后续活动。`;

  let clubAuto = { raf: 0, last: 0, speed: 28, hoverPause: false, scrollEl: null };

  function stopClubAutoScroll(){
    if(clubAuto.raf) cancelAnimationFrame(clubAuto.raf);
    clubAuto.raf = 0;
    clubAuto.last = 0;
    clubAuto.scrollEl = null;
    clubAuto.hoverPause = false;
  }
  function startClubAutoScroll(scrollEl){
    stopClubAutoScroll();
    clubAuto.scrollEl = scrollEl;
    try{ scrollEl.scrollTop = 0; }catch(e){}

    const step = (now) => {
      if(!clubAuto.scrollEl) { clubAuto.raf = 0; return; }
      if(!clubAuto.last) clubAuto.last = now;
      const dt = (now - clubAuto.last) / 1000;
      clubAuto.last = now;

      const el = clubAuto.scrollEl;
      if(!clubAuto.hoverPause){
        const maxTop = Math.max(0, el.scrollHeight - el.clientHeight);
        el.scrollTop = Math.min(maxTop, el.scrollTop + clubAuto.speed * dt);
        if(el.scrollTop >= maxTop - 0.5) el.scrollTop = 0;
      }
      clubAuto.raf = requestAnimationFrame(step);
    };

    clubAuto.raf = requestAnimationFrame(step);
  }

  function openClub(){
    activeSheetKey = 'club';
    const sub = model.lang === 'en'
      ? 'Aviation club revival — left story + right auto-playing photos'
      : '航协复兴 — 左侧叙述 + 右侧图片自动播放';
    const h3 = model.lang === 'en' ? 'Aviation Club Revival' : '航协复兴';
    const text = model.lang === 'en' ? CLUB_TEXT_EN : CLUB_TEXT_ZH;

    showSheet('club', sub, (root) => {
      const wrap = document.createElement('div');
      wrap.className = 'clubWrap';

      const textBox = document.createElement('div');
      textBox.className = 'clubText';
      textBox.innerHTML = `
        <h3>${escapeHtml(h3)}</h3>
        <p style="white-space:pre-wrap">${escapeHtml(text)}</p>
      `;

      const gallery = document.createElement('div');
      gallery.className = 'clubGallery';

      const scroll = document.createElement('div');
      scroll.className = 'clubScroll';

      const rail = document.createElement('div');
      rail.className = 'clubRail';

      const makeShot = (url, idx, totalLabel) => {
        const shot = document.createElement('div');
        shot.className = 'clubShot';
        shot.innerHTML = `
          <img src="${escapeHtml(url)}" alt="club photo ${idx+1}" loading="lazy" decoding="async" />
          <div class="clubMeta">
            <div>${escapeHtml(model.lang === 'en' ? 'Club Photography' : '社团活动摄影')}</div>
            <div class="tag">${escapeHtml(totalLabel)}</div>
          </div>
        `;
        return shot;
      };

      CLUB_IMAGES.forEach((url, idx) => rail.appendChild(makeShot(url, idx, `img-${idx+1}`)));
      CLUB_IMAGES.forEach((url, idx) => rail.appendChild(makeShot(url, idx, `img-${idx+1}-loop`)));

      scroll.appendChild(rail);
      gallery.appendChild(scroll);

      const pause = () => { clubAuto.hoverPause = true; };
      const resume = () => { clubAuto.hoverPause = false; };

      scroll.addEventListener('pointerenter', pause, {passive:true});
      scroll.addEventListener('pointerleave', resume, {passive:true});
      scroll.addEventListener('wheel', pause, {passive:true});
      scroll.addEventListener('pointerdown', pause, {passive:true});
      scroll.addEventListener('touchstart', pause, {passive:true});
      scroll.addEventListener('touchend', resume, {passive:true});

      wrap.appendChild(textBox);
      wrap.appendChild(gallery);
      root.appendChild(wrap);

      requestAnimationFrame(() => startClubAutoScroll(scroll));
    });
  }

  function openNavPage(id){
    activeSheetKey = id;
    const titleMap = { p3: 'page3', p4: 'page4' };
    const title = titleMap[id] || 'page';
    const sub = model.lang === 'en' ? 'Navigation page' : '导航页面';
    showSheet(title, sub, (root) => {
      const p = document.createElement('div');
      p.className = 'panel';
      p.innerHTML = `
        <h3 class="panelTitle">${escapeHtml(title)}</h3>
        <div class="small">
          ${model.lang === 'en'
            ? 'This is a new page opened from the top-right parallelogram navigation.'
            : '这是从右上角平行四边形导航打开的新页面。'
          }
        </div>
      `;
      root.appendChild(p);
    });
  }

  /* Spheres system */
  const spheres = [];
  const pointer = {x:0, y:0, inside:false};

  function randomScale(){ return 0.90 + Math.random()*0.20; }

  function buildSpheres(){
    els.stage.innerHTML = '';
    spheres.length = 0;

    const rect = els.stage.getBoundingClientRect();
    const base = Math.min(rect.width, rect.height);
    const baseSize = clamp(base * 0.14, 110, 170) * 1.5;

    const keys = ['home','about','projects','pubs','contact','cv','edit'];
    const c = t();

    const pad = 18;
    const regionX0 = pad;
    const regionY0 = rect.height * 0.52;
    const regionX1 = rect.width - pad;
    const regionY1 = rect.height - pad;

    const tmp = keys.map(key => {
      const sc = randomScale();
      const sizePx = baseSize * sc;
      const baseR = sizePx / 2;
      return {key, sizePx, baseR};
    });

    const placed = [];

    function tryPlaceOne(item, attempts=900){
      for(let k=0;k<attempts;k++){
        const x = regionX0 + Math.random()*(regionX1-regionX0);
        const y = regionY0 + Math.random()*(regionY1-regionY0);

        let ok = true;
        for(const p of placed){
          const d = Math.hypot(x - p.ax, y - p.ay);
          const minD = (item.baseR + p.baseR) + 14;
          if(d < minD){ ok = false; break; }
        }
        if(ok){
          placed.push({ax:x, ay:y, baseR:item.baseR, key:item.key, sizePx:item.sizePx});
          return true;
        }
      }
      return false;
    }

    tmp.sort((a,b)=>b.baseR-a.baseR).forEach(it => {
      const ok = tryPlaceOne(it);
      if(!ok){
        const x = (regionX0+regionX1)/2 + (Math.random()-0.5)*80;
        const y = (regionY0+regionY1)/2 + (Math.random()-0.5)*80;
        placed.push({ax:x, ay:y, baseR:it.baseR, key:it.key, sizePx:it.sizePx});
      }
    });

    for(const p of placed){
      const el = document.createElement('div');
      el.className = 'ball';
      el.style.width = p.sizePx.toFixed(1) + 'px';
      el.style.height = p.sizePx.toFixed(1) + 'px';
      el.style.setProperty('--ballBright', '0');

      const def = c.spheres[p.key];
      el.innerHTML = `
        <div class="label">
          <div class="title">${escapeHtml(def.title)}</div>
          <div class="desc">${escapeHtml(def.desc)}</div>
          <div class="tiny">${escapeHtml(def.tiny || '')}</div>
        </div>
      `;
      els.stage.appendChild(el);

      const angle = Math.random()*Math.PI*2;
      const speed = 0.08 + Math.random()*0.10;
      const vx = Math.cos(angle)*speed;
      const vy = Math.sin(angle)*speed;

      const s = {
        key: p.key,
        el,
        x: p.ax,
        y: p.ay,
        vx,
        vy,

        baseR: p.baseR,
        scale: 1,
        scaleTarget: 1,
        r: p.baseR,
        rTarget: p.baseR,

        bright: 0,
        brightTarget: 0,

        influence: clamp(base * 0.30, 220, 360),
      };

      el.addEventListener('click', () => onSphereClick(s.key));
      spheres.push(s);
    }

    resolveCollisionsAndBounds(28);
    renderSpheres();
  }

  function refreshSphereLabels(){
    const c = t();
    for(const s of spheres){
      const def = c.spheres[s.key];
      if(!def) continue;
      const titleEl = s.el.querySelector('.title');
      const descEl  = s.el.querySelector('.desc');
      const tinyEl  = s.el.querySelector('.tiny');
      if(titleEl) titleEl.textContent = def.title;
      if(descEl)  descEl.textContent  = def.desc;
      if(tinyEl)  tinyEl.textContent  = def.tiny || '';
    }
  }

  function renderSpheres(){
    for(const s of spheres){
      const tx = (s.x - s.baseR);
      const ty = (s.y - s.baseR);
      const rx = Math.round(tx * 10) / 10;
      const ry = Math.round(ty * 10) / 10;
      s.el.style.transform = `translate3d(${rx}px, ${ry}px, 0) scale(${s.scale.toFixed(4)})`;
    }
  }

  function clampToBoundsAndBounce(s, w, h){
    const pad = 14;
    const minX = s.r + pad;
    const maxX = w - s.r - pad;
    const minY = s.r + pad;
    const maxY = h - s.r - pad;

    if(s.x < minX){ s.x = minX; s.vx = Math.abs(s.vx); }
    if(s.x > maxX){ s.x = maxX; s.vx = -Math.abs(s.vx); }
    if(s.y < minY){ s.y = minY; s.vy = Math.abs(s.vy); }
    if(s.y > maxY){ s.y = maxY; s.vy = -Math.abs(s.vy); }
  }

  function resolveCollisionsAndBounds(iterations){
    const rect = els.stage.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    const gap = 10;

    for(let iter=0; iter<iterations; iter++){
      for(let i=0;i<spheres.length;i++){
        for(let j=i+1;j<spheres.length;j++){
          const a = spheres[i], b = spheres[j];
          const dx = b.x - a.x;
          const dy = b.y - a.y;
          const dist = Math.hypot(dx,dy) || 0.0001;
          const minDist = (a.r + b.r) + gap;
          if(dist < minDist){
            const overlap = (minDist - dist);
            const ux = dx / dist, uy = dy / dist;
            const push = overlap * 0.51;

            a.x -= ux * push;
            a.y -= uy * push;
            b.x += ux * push;
            b.y += uy * push;

            const av = a.vx*ux + a.vy*uy;
            const bv = b.vx*ux + b.vy*uy;
            a.vx -= ux * av * 0.35;
            a.vy -= uy * av * 0.35;
            b.vx -= uy * bv * 0.35;
            b.vy -= uy * bv * 0.35;
          }
        }
      }
      for(const s of spheres) clampToBoundsAndBounce(s, w, h);
    }
  }

  function tickSpheres(){
    const rect = els.stage.getBoundingClientRect();
    const w = rect.width, h = rect.height;

    const mx = pointer.x - rect.left;
    const my = pointer.y - rect.top;

    let nearest = null;
    let nearestD = Infinity;
    if(pointer.inside){
      for(const s of spheres){
        const d = Math.hypot(s.x - mx, s.y - my);
        if(d < nearestD){ nearestD = d; nearest = s; }
      }
    }

    const mousePullRadius = Math.min(w,h) * 0.28;
    const mousePullStrength = 0.018;
    if(nearest && nearestD < mousePullRadius){
      const dx = mx - nearest.x;
      const dy = my - nearest.y;
      nearest.vx += dx * mousePullStrength;
      nearest.vy += dy * mousePullStrength;
    }

    for(const s of spheres){
      const d = (pointer.inside ? Math.hypot(s.x - mx, s.y - my) : s.influence*2);
      const tdist = clamp(d / s.influence, 0, 1);

      s.scaleTarget = lerp(1.5, 0.5, tdist);
      s.scale = lerp(s.scale, s.scaleTarget, 0.12);

      s.rTarget = s.baseR * s.scale;
      s.r = lerp(s.r, s.rTarget, 0.20);

      s.brightTarget = 1 - tdist;
      s.bright = lerp(s.bright, s.brightTarget, 0.18);
      const gray = Math.round(140 * s.bright);
      s.el.style.setProperty('--ballBright', String(gray));
    }

    const driftNoise = 0.010;
    const damping = 0.992;
    const maxV = 0.55;
    const repelK = 0.0022;
    const repelRangeFactor = 1.18;

    for(const s of spheres){
      s.vx += (Math.random()-0.5) * driftNoise;
      s.vy += (Math.random()-0.5) * driftNoise;

      s.vx *= damping;
      s.vy *= damping;

      s.vx = clamp(s.vx, -maxV, maxV);
      s.vy = clamp(s.vy, -maxV, maxV);
    }

    for(let i=0;i<spheres.length;i++){
      for(let j=i+1;j<spheres.length;j++){
        const a = spheres[i], b = spheres[j];
        const dx = b.x - a.x;
        const dy = b.y - a.y;
        const dist = Math.hypot(dx,dy) || 0.0001;
        const minDist = (a.r + b.r) * repelRangeFactor + 10;

        if(dist < minDist){
          const ux = dx / dist, uy = dy / dist;
          const tt = 1 - clamp(dist / minDist, 0, 1);
          const f = nonlinear2(tt) * repelK * 120;
          a.vx -= ux * f;
          a.vy -= uy * f;
          b.vx += ux * f;
          b.vy += uy * f;
        }
      }
    }

    for(const s of spheres){
      s.x += s.vx;
      s.y += s.vy;
      clampToBoundsAndBounce(s, w, h);
    }

    resolveCollisionsAndBounds(10);
    renderSpheres();
    requestAnimationFrame(tickSpheres);
  }

  els.stage.addEventListener('pointerenter', () => { pointer.inside = true; }, {passive:true});
  els.stage.addEventListener('pointerleave', () => { pointer.inside = false; }, {passive:true});
  window.addEventListener('pointermove', (e) => { pointer.x = e.clientX; pointer.y = e.clientY; }, {passive:true});

  function rebuildSpheres(){
    buildSpheres();
    refreshSphereLabels();
  }

  function onSphereClick(key){
    if(key === 'home') return openHome();
    if(key === 'about') return openAbout();
    if(key === 'projects') return openProjects();
    if(key === 'pubs') return openPubs();
    if(key === 'contact') return openContact();
    if(key === 'cv') return openCV();
    if(key === 'edit') return openEditor();
  }

  function openHome(){
    activeSheetKey = 'home';
    const c = t();
    const sec = c.sections.home;
    showSheet(c.spheres.home.title, c.spheres.home.desc, (root) => {
      const p = document.createElement('div');
      p.className = 'panel';
      p.innerHTML = `
        <h3 class="panelTitle">${escapeHtml(sec.headline)}</h3>
        <div class="small">${escapeHtml(sec.highlight)}</div>
        <div class="hr"></div>
        <h3 class="panelTitle">${escapeHtml(sec.focusTitle)}</h3>
        <div class="small">${escapeHtml(sec.focusBody)}</div>
        <div class="hr"></div>
        <div class="small">${escapeHtml(sec.orderHint)}</div>
      `;
      root.appendChild(p);
    });
  }

  function openAbout(){
    activeSheetKey = 'about';
    const c = t();
    const sec = c.sections.about;
    showSheet(c.spheres.about.title, c.spheres.about.desc, (root) => {
      const p = document.createElement('div');
      p.className = 'panel';
      p.innerHTML = `
        <h3 class="panelTitle">${escapeHtml(sec.title)}</h3>
        <div class="small" style="white-space:pre-wrap">${escapeHtml(sec.body)}</div>
      `;
      root.appendChild(p);
    });
  }

  function openProjects(){
    activeSheetKey = 'projects';
    const c = t();
    const sec = c.sections.projects;
    showSheet(c.spheres.projects.title, c.spheres.projects.desc, (root) => {
      const top = document.createElement('div');
      top.className = 'panel';
      top.innerHTML = `
        <h3 class="panelTitle">${escapeHtml(sec.title)}</h3>
        <div class="cards">
          <div class="card">
            <h4>${escapeHtml(sec.mainProjectTitle)}</h4>
            <div class="kv">
              <div><b>Goal</b></div><div>${escapeHtml(sec.goal)}</div>
              <div><b>Approach</b></div><div>${escapeHtml(sec.method)}</div>
            </div>
          </div>
          <div class="card">
            <h4>${escapeHtml(sec.demoTitle)}</h4>
            <div class="small">
              <a class="link" href="${escapeHtml(sec.demoUrl)}" target="_blank" rel="noopener">Open YouTube link</a>
            </div>
            <div class="small mono">${escapeHtml(sec.demoUrl)}</div>
            <div class="small">${model.lang === 'en'
              ? 'Tip: replace this link with your final demo video URL.'
              : '提示：后续把这里替换成你的最终演示视频链接。'
            }</div>
          </div>
        </div>
      `;
      root.appendChild(top);

      const mile = document.createElement('div');
      mile.className = 'panel';
      mile.innerHTML = `<h3 class="panelTitle">${model.lang === 'en' ? 'Milestones' : '里程碑'}</h3>`;
      const list = document.createElement('div');
      list.className = 'cards';
      sec.milestones.forEach(m => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h4>${escapeHtml(m.when)}</h4>
          <div class="small">${escapeHtml(m.what)}</div>
        `;
        list.appendChild(card);
      });
      mile.appendChild(list);
      root.appendChild(mile);
    });
  }

  function openPubs(){
    activeSheetKey = 'pubs';
    const c = t();
    const sec = c.sections.pubs;
    showSheet(c.spheres.pubs.title, c.spheres.pubs.desc, (root) => {
      const p = document.createElement('div');
      p.className = 'panel';
      p.innerHTML = `
        <h3 class="panelTitle">${escapeHtml(sec.title)}</h3>
        <div class="small">${escapeHtml(sec.body)}</div>
      `;
      root.appendChild(p);
    });
  }

  function openContact(){
    activeSheetKey = 'contact';
    const c = t();
    const sec = c.sections.contact;
    showSheet(c.spheres.contact.title, c.spheres.contact.desc, (root) => {
      const p = document.createElement('div');
      p.className = 'panel';
      p.innerHTML = `
        <h3 class="panelTitle">${escapeHtml(sec.title)}</h3>
        <div class="kv" style="grid-template-columns: 120px 1fr">
          <div><b>${escapeHtml(sec.emailLabel)}</b></div>
          <div><a class="link" href="mailto:${escapeHtml(sec.emailValue)}">${escapeHtml(sec.emailValue)}</a></div>
        </div>
      `;
      root.appendChild(p);

      const formPanel = document.createElement('div');
      formPanel.className = 'panel';
      formPanel.innerHTML = `
        <h3 class="panelTitle">${escapeHtml(sec.messageTitle)}</h3>
        <div class="small">${escapeHtml(sec.messageHint)}</div>
        <div class="hr"></div>
        <div style="border:1px solid rgba(255,255,255,.10); border-radius:16px; overflow:hidden; background: rgba(0,0,0,.18);">
          <iframe
            title="Message Form"
            src="${escapeHtml(sec.formEmbedUrl)}"
            style="width:100%; height:620px; border:0; display:block;"
            loading="lazy"
            referrerpolicy="no-referrer"
          ></iframe>
        </div>
        <div class="small mono" style="word-break:break-all">${escapeHtml(sec.formEmbedUrl)}</div>
      `;
      root.appendChild(formPanel);
    });
  }

  function openCV(){
    activeSheetKey = 'cv';
    const c = t();
    const sec = c.sections.cv;
    showSheet(c.spheres.cv.title, c.spheres.cv.desc, (root) => {
      const p = document.createElement('div');
      p.className = 'panel';
      p.innerHTML = `
        <h3 class="panelTitle">${escapeHtml(sec.title)}</h3>
        <div class="small">${escapeHtml(sec.body)}</div>
        <div class="hr"></div>
        <div class="cvBox">
          <div class="small" style="margin-bottom:8px">${model.lang === 'en' ? 'Quick bullets (editable):' : '要点（可编辑）：'}</div>
          <ul class="small" style="margin:0; padding-left: 18px">
            ${sec.bullets.map(x => `<li>${escapeHtml(x)}</li>`).join('')}
          </ul>
        </div>
      `;
      root.appendChild(p);
    });
  }

  function openEditor(){
    activeSheetKey = 'edit';
    const c = t();
    const sec = c.sections.edit;

    showSheet(c.spheres.edit.title, c.spheres.edit.desc, (root) => {
      const top = document.createElement('div');
      top.className = 'panel';
      top.innerHTML = `
        <h3 class="panelTitle">${escapeHtml(sec.title)}</h3>
        <div class="small">${escapeHtml(sec.sub)}</div>
        <div class="small">${escapeHtml(sec.note)}</div>
      `;
      root.appendChild(top);

      const editor = document.createElement('div');
      editor.className = 'panel';
      editor.innerHTML = `
        <h3 class="panelTitle">${model.lang === 'en' ? 'Core' : '核心内容'}</h3>
        <div class="col">
          <label>${model.lang === 'en' ? 'Hero title' : '首页标题'}</label>
          <input id="ed_heroTitle" type="text" value="${escapeHtml(c.heroTitle)}">
        </div>
        <div class="col">
          <label>${model.lang === 'en' ? 'Hero subtitle' : '首页副标题'}</label>
          <textarea id="ed_heroSub">${escapeHtml(c.heroSub)}</textarea>
        </div>

        <div class="hr"></div>

        <h3 class="panelTitle">${model.lang === 'en' ? 'About text' : '关于我正文'}</h3>
        <textarea id="ed_aboutBody">${escapeHtml(c.sections.about.body)}</textarea>
      `;
      root.appendChild(editor);

      const bindInput = (id, setter) => {
        const el = editor.querySelector('#' + id);
        el.addEventListener('input', () => {
          setter(el.value);
          scheduleSave();
          applyLangToUI();
          refreshSphereLabels();
        });
      };

      bindInput('ed_heroTitle', (v) => { c.heroTitle = v; });
      bindInput('ed_heroSub', (v) => { c.heroSub = v; });
      bindInput('ed_aboutBody', (v) => { c.sections.about.body = v; });
    });
  }

  function downloadTextFile(content, filename){
    const blob = new Blob([content], {type:'text/plain;charset=UTF-8'});
    const a = document.createElement('a');
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  function allToText(){
    const cEN = model.content.en;
    const cZH = model.content.zh;

    const lines = [];
    lines.push('L — Personal Website (Backup)');
    lines.push('Export time: ' + new Date().toLocaleString());
    lines.push('');
    lines.push('[EN] Hero: ' + (cEN.heroTitle || ''));
    lines.push(cEN.heroSub || '');
    lines.push('');
    lines.push('[EN] About:');
    lines.push(cEN.sections.about.body || '');
    lines.push('');
    lines.push('---');
    lines.push('');
    lines.push('[ZH] 标题：' + (cZH.heroTitle || ''));
    lines.push(cZH.heroSub || '');
    lines.push('');
    lines.push('[ZH] 关于我：');
    lines.push(cZH.sections.about.body || '');
    return lines.join('\n');
  }

  function downloadAllText(){ downloadTextFile(allToText(), 'L_site_backup.txt'); }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(model, null, 2)], {type:'application/json;charset=UTF-8'});
    const a = document.createElement('a');
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = 'L_site_export.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  async function importJSON(file){
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      if(!obj || typeof obj !== 'object') return;

      if(obj.lang === 'en' || obj.lang === 'zh') model.lang = obj.lang;
      if(obj.content && obj.content.en) model.content.en = {...model.content.en, ...obj.content.en};
      if(obj.content && obj.content.zh) model.content.zh = {...model.content.zh, ...obj.content.zh};

      model.updatedAt = Date.now();
      scheduleSave();
      applyLangToUI();
      rebuildSpheres();
    }catch(e){}
  }

  async function clearAll(){
    const title = model.lang === 'en' ? 'Clear all' : '清空全部';
    const msg = model.lang === 'en'
      ? 'Are you sure you want to clear all locally saved edits? This cannot be undone.'
      : '确定清空所有本地保存的编辑内容吗？此操作不可撤回。';
    const ok = await confirmLike(title, msg);
    if(!ok) return;
    try{ localStorage.removeItem(LS_KEY); }catch(e){}
    location.reload();
  }

  els.btnLangDock.addEventListener('click', (e) => { e.preventDefault(); toggleLang(); });
  els.btnDownloadTextDock.addEventListener('click', (e) => { e.preventDefault(); downloadAllText(); });
  els.btnExportJSONDock.addEventListener('click', (e) => { e.preventDefault(); exportJSON(); });
  els.importJSONDock.addEventListener('change', async (e) => {
    const f = e.target.files && e.target.files[0];
    e.target.value = '';
    if(f) await importJSON(f);
  });
  els.btnClearAllDock.addEventListener('click', (e) => { e.preventDefault(); clearAll(); });

  /* Nav bindings */
  els.navClub.addEventListener('click', (e) => { e.preventDefault(); openClub(); });
  els.navPara3.addEventListener('click', (e) => { e.preventDefault(); openNavPage('p3'); });
  els.navPara4.addEventListener('click', (e) => { e.preventDefault(); openNavPage('p4'); });

  /* Background canvas animation */
  const ctx = els.bg.getContext('2d', {alpha:true});
  const bgPointer = {x:0.5, y:0.5, vx:0, vy:0, down:false};
  const blobs = [];
  const BLOB_COUNT = 16;

  function resizeBg(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    els.bg.width = Math.floor(innerWidth * dpr);
    els.bg.height = Math.floor(innerHeight * dpr);
    els.bg.style.width = innerWidth + 'px';
    els.bg.style.height = innerHeight + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  function initBg(){
    blobs.length = 0;
    for(let i=0;i<BLOB_COUNT;i++){
      blobs.push({
        x: Math.random(),
        y: Math.random(),
        r: 0.05 + Math.random()*0.12,
        a: 0.26 + Math.random()*0.40,
        vx: (Math.random()-.5)*0.0008,
        vy: (Math.random()-.5)*0.0008,
        phase: Math.random()*Math.PI*2
      });
    }
  }
  function drawBg(){
    const w = innerWidth, h = innerHeight;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = 'rgba(255,255,255,0.035)';
    ctx.fillRect(0,0,w,h);

    for(const b of blobs){
      b.phase += 0.01;
      b.x += b.vx + Math.sin(b.phase)*0.00015 + bgPointer.vx*0.0007;
      b.y += b.vy + Math.cos(b.phase)*0.00015 + bgPointer.vy*0.0007;

      if(b.x < -0.2) b.x = 1.2;
      if(b.x > 1.2) b.x = -0.2;
      if(b.y < -0.2) b.y = 1.2;
      if(b.y > 1.2) b.y = -0.2;

      const cx = b.x*w;
      const cy = b.y*h;
      const rr = Math.max(30, b.r * Math.min(w,h) * (bgPointer.down ? 1.25 : 1.0));

      const g = ctx.createRadialGradient(cx,cy,0,cx,cy,rr);
      g.addColorStop(0, `rgba(255,255,255,${0.14*b.a})`);
      g.addColorStop(0.35, `rgba(190,190,190,${0.12*b.a})`);
      g.addColorStop(1, `rgba(0,0,0,0)`);

      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(cx,cy,rr,0,Math.PI*2);
      ctx.fill();
    }

    const vg = ctx.createRadialGradient(w*0.5,h*0.45,Math.min(w,h)*0.1,w*0.5,h*0.5,Math.max(w,h)*0.7);
    vg.addColorStop(0, 'rgba(0,0,0,0)');
    vg.addColorStop(1, 'rgba(0,0,0,0.46)');
    ctx.fillStyle = vg;
    ctx.fillRect(0,0,w,h);

    requestAnimationFrame(drawBg);
  }

  window.addEventListener('pointermove', (e) => {
    const nx = e.clientX / Math.max(1, innerWidth);
    const ny = e.clientY / Math.max(1, innerHeight);
    const dx = nx - bgPointer.x;
    const dy = ny - bgPointer.y;
    bgPointer.vx = dx;
    bgPointer.vy = dy;
    bgPointer.x = nx;
    bgPointer.y = ny;
  }, {passive:true});
  window.addEventListener('pointerdown', () => { bgPointer.down = true; }, {passive:true});
  window.addEventListener('pointerup', () => { bgPointer.down = false; }, {passive:true});

  /* ============ Simulator navigation (enter/exit) ============ */
  let simulatorStartedOnce = false;

  function showSimulator(){
    closeSheet();
    // Hide personal site UI but keep in DOM
    els.siteRoot.style.display = 'none';
    els.rightDock.style.display = 'none';
    els.bg.style.display = 'none';

    els.simulatorRoot.classList.add('active');
    els.simulatorRoot.setAttribute('aria-hidden','false');

    // Start simulator when first entered (load module)
    if(!simulatorStartedOnce){
      simulatorStartedOnce = true;
      import('./__simulator_module__.js').catch(()=>{ /* ignore */ });
    }else{
      // If previously started, just resume rendering visibility
      if(window.__SIMULATOR_APP__?.setVisible) window.__SIMULATOR_APP__.setVisible(true);
    }
  }

  function hideSimulator(){
    els.simulatorRoot.classList.remove('active');
    els.simulatorRoot.setAttribute('aria-hidden','true');

    els.siteRoot.style.display = '';
    els.rightDock.style.display = '';
    els.bg.style.display = '';

    if(window.__SIMULATOR_APP__?.setVisible) window.__SIMULATOR_APP__.setVisible(false);
  }

  els.navSimulator.addEventListener('click', (e) => {
    e.preventDefault();
    showSimulator();
  });
  els.btnBackToSite.addEventListener('click', (e) => {
    e.preventDefault();
    hideSimulator();
  });

  /* Init personal site */
  function init(){
    load();
    applyLangToUI();
    setDockOpen(false);

    setTriVars(1, 1, 0.28, '10,10,12');

    resizeBg();
    initBg();
    requestAnimationFrame(drawBg);

    rebuildSpheres();
    requestAnimationFrame(tickSpheres);

    setTimeout(() => { els.triWrap.classList.remove('enter'); }, 700);

    function onResize(){
      resizeBg();
      rebuildSpheres();
      if(triState === 'expanded'){
        const target = computeTriTargetScales();
        setTriVars(target.sx, target.sy, 1.0, '10,10,12');
      }
      if(window.__SIMULATOR_APP__?.resize) window.__SIMULATOR_APP__.resize();
    }
    window.addEventListener('resize', onResize);

    pointer.x = innerWidth * 0.5;
    pointer.y = innerHeight * 0.5;

    saveNow();
  }

  init();
})();
</script>

<!-- Simulator module (inline as ESM via Blob URL; keeps a single HTML file) -->
<script type="module">
  const simCode = `
import * as THREE from 'https://jsd.onmicrosoft.cn/npm/three@0.159.0/build/three.module.js';

const clamp = (x, a, b) => Math.min(b, Math.max(a, x));
const lerp = (a, b, t) => a + (b - a) * t;
const rad2deg = r => r * 180 / Math.PI;
const easeInOut = (t) => { t = clamp(t, 0, 1); return t*t*(3 - 2*t); };

const root = document.getElementById('simulatorRoot');
const btnStart = document.getElementById('btnStart');
const btnRestart = document.getElementById('btnRestart');

const liftEl = document.getElementById('lift');
const dragEl = document.getElementById('drag');
const liftValEl = document.getElementById('liftVal');
const dragValEl = document.getElementById('dragVal');

const windSpeedEl = document.getElementById('windSpeed');
const windDirEl = document.getElementById('windDir');
const windSpeedValEl = document.getElementById('windSpeedVal');
const windDirValEl = document.getElementById('windDirVal');

const hudThrottle = document.getElementById('hudThrottle');
const hudSpeed = document.getElementById('hudSpeed');
const hudAlt = document.getElementById('hudAlt');
const hudAoA = document.getElementById('hudAoA');

function syncSliders() {
  liftValEl.textContent = Number(liftEl.value).toFixed(2);
  dragValEl.textContent = Number(dragEl.value).toFixed(3);
  windSpeedValEl.textContent = Number(windSpeedEl.value).toFixed(1);
  windDirValEl.textContent = String(Math.round(Number(windDirEl.value)));
}
liftEl.addEventListener('input', syncSliders);
dragEl.addEventListener('input', syncSliders);
windSpeedEl.addEventListener('input', syncSliders);
windDirEl.addEventListener('input', syncSliders);
syncSliders();

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);
renderer.setClearColor(0x66aaff, 1);
root.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x66aaff, 300, 5500);

const camera = new THREE.PerspectiveCamera(70, innerWidth / innerHeight, 0.1, 20000);

scene.add(new THREE.HemisphereLight(0xddeeff, 0x553311, 0.9));
const dir = new THREE.DirectionalLight(0xffffff, 0.7);
dir.position.set(200, 500, 150);
scene.add(dir);

const groundGeo = new THREE.PlaneGeometry(20000, 20000, 1, 1);
const groundMat = new THREE.MeshLambertMaterial({ color: 0x7a4a1f });
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI / 2;
ground.position.y = 0;
scene.add(ground);

const gridWhiteFine = new THREE.GridHelper(20000, 400, 0xffffff, 0xffffff);
gridWhiteFine.material.opacity = 0.12;
gridWhiteFine.material.transparent = true;
gridWhiteFine.position.y = 0.014;
scene.add(gridWhiteFine);

const gridWhiteCoarse = new THREE.GridHelper(20000, 80, 0xffffff, 0xffffff);
gridWhiteCoarse.material.opacity = 0.18;
gridWhiteCoarse.material.transparent = true;
gridWhiteCoarse.position.y = 0.015;
scene.add(gridWhiteCoarse);

const craft = new THREE.Group();
const bodyGeo = new THREE.ConeGeometry(1.2, 4.2, 3, 1, false);
const bodyMat = new THREE.MeshStandardMaterial({ color: 0xffdd55, metalness: 0.05, roughness: 0.55 });
const body = new THREE.Mesh(bodyGeo, bodyMat);
body.rotation.x = Math.PI / 2;
craft.add(body);

const finGeo = new THREE.BoxGeometry(0.15, 0.9, 1.4);
const finMat = new THREE.MeshStandardMaterial({ color: 0x222222, metalness: 0.0, roughness: 0.9 });
const fin = new THREE.Mesh(finGeo, finMat);
fin.position.set(0, 0.55, -1.2);
craft.add(fin);

craft.position.set(0, 30, 0);
scene.add(craft);

// Trail
const trailColor = new THREE.Color(0x88ffbb);
const trailMat = new THREE.MeshBasicMaterial({
  color: trailColor,
  transparent: true,
  opacity: 0.55,
  depthWrite: false,
  side: THREE.DoubleSide
});
const trailGeo = new THREE.BufferGeometry();
const trailRibbon = new THREE.Mesh(trailGeo, trailMat);
scene.add(trailRibbon);

let trailPoints = [];
function resetTrail() {
  trailPoints = [];
  const p0 = craft.position.clone();
  const r0 = new THREE.Vector3(1, 0, 0).applyQuaternion(craft.quaternion).normalize();
  trailPoints.push({ p: p0, r: r0, s: 0 });
  updateTrailGeometry();
}
function updateTrailGeometry() {
  if (trailPoints.length < 2) {
    trailGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(0), 3));
    trailGeo.setAttribute('uv', new THREE.BufferAttribute(new Float32Array(0), 2));
    trailGeo.setIndex([]);
    trailGeo.computeBoundingSphere();
    return;
  }
  const n = trailPoints.length;
  const wHead = 0.85;
  const wTail = 0.25;

  const positions = new Float32Array(n * 2 * 3);
  const uvs = new Float32Array(n * 2 * 2);
  const indices = [];

  const tangent = new THREE.Vector3();
  const side = new THREE.Vector3();

  for (let i = 0; i < n; i++) {
    const p = trailPoints[i].p;
    const pPrev = trailPoints[Math.max(0, i - 1)].p;
    const pNext = trailPoints[Math.min(n - 1, i + 1)].p;
    tangent.copy(pNext).sub(pPrev);
    const tl = tangent.length();
    if (tl < 1e-6) tangent.set(0, 0, 1);
    else tangent.multiplyScalar(1 / tl);

    side.copy(trailPoints[i].r);
    side.addScaledVector(tangent, -side.dot(tangent));
    if (side.lengthSq() < 1e-6) {
      const upWorld = new THREE.Vector3(0, 1, 0);
      side.crossVectors(tangent, upWorld);
      if (side.lengthSq() < 1e-6) side.set(1, 0, 0);
    }
    side.normalize();

    const t = (n === 1) ? 0 : (i / (n - 1));
    const width = lerp(wTail, wHead, t);

    const left = p.clone().addScaledVector(side, -width * 0.5);
    const right = p.clone().addScaledVector(side,  width * 0.5);

    const basePos = i * 2 * 3;
    positions[basePos + 0] = left.x;
    positions[basePos + 1] = left.y;
    positions[basePos + 2] = left.z;
    positions[basePos + 3] = right.x;
    positions[basePos + 4] = right.y;
    positions[basePos + 5] = right.z;

    const baseUv = i * 2 * 2;
    uvs[baseUv + 0] = 0;
    uvs[baseUv + 1] = t;
    uvs[baseUv + 2] = 1;
    uvs[baseUv + 3] = t;

    if (i < n - 1) {
      const a = i * 2;
      const b = i * 2 + 1;
      const c = (i + 1) * 2;
      const d = (i + 1) * 2 + 1;
      indices.push(a, c, b, b, c, d);
    }
  }
  trailGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  trailGeo.setAttribute('uv', new THREE.BufferAttribute(uvs, 2));
  trailGeo.setIndex(indices);
  trailGeo.computeVertexNormals();
  trailGeo.computeBoundingSphere();
}
function addTrailPoint(maxLen = 40) {
  const p = craft.position.clone();
  const r = new THREE.Vector3(1, 0, 0).applyQuaternion(craft.quaternion).normalize();

  const last = trailPoints[trailPoints.length - 1]?.p;
  if (!last) {
    trailPoints.push({ p, r, s: 0 });
    updateTrailGeometry();
    return;
  }
  const seg = p.distanceTo(last);
  if (seg < 0.22) return;

  const s = trailPoints[trailPoints.length - 1].s + seg;
  trailPoints.push({ p, r, s });

  while (trailPoints.length > 2) {
    const total = trailPoints[trailPoints.length - 1].s - trailPoints[0].s;
    if (total <= maxLen) break;
    trailPoints.shift();
  }
  const s0 = trailPoints[0].s;
  for (const it of trailPoints) it.s -= s0;

  updateTrailGeometry();
}

// Flag
const flagGroup = new THREE.Group();
const flagPoleGeo = new THREE.CylinderGeometry(0.12, 0.12, 10, 14);
const flagPoleMat = new THREE.MeshStandardMaterial({ color: 0xb9c0c8, metalness: 0.25, roughness: 0.55 });
const flagPole = new THREE.Mesh(flagPoleGeo, flagPoleMat);
flagPole.position.y = 5;
flagGroup.add(flagPole);

const flagArmGeo = new THREE.CylinderGeometry(0.06, 0.06, 1.2, 12);
const flagArmMat = flagPoleMat.clone();
const flagArm = new THREE.Mesh(flagArmGeo, flagArmMat);
flagArm.rotation.z = Math.PI / 2;
flagArm.position.set(0.6, 9.6, 0);
flagGroup.add(flagArm);

const flagSockPivot = new THREE.Group();
flagSockPivot.position.set(0.0, 9.6, 0.0);
flagGroup.add(flagSockPivot);

const frInner = 2.5 / 2;
const frOuter = 1.5 / 2;
const flagLen = 8.0;
const flagRadialSeg = 48;
const stripeStep = 2.0;
const stripeSegments = Math.round(flagLen / stripeStep);
const geoLenSeg = stripeSegments;
const flagConeGeo = new THREE.CylinderGeometry(frOuter, frInner, flagLen, flagRadialSeg, geoLenSeg, true);

const flagMatWhite = new THREE.MeshStandardMaterial({ color: 0xf6f6f6, metalness: 0.0, roughness: 0.8, side: THREE.DoubleSide });
const flagMatRed   = new THREE.MeshStandardMaterial({ color: 0xff3b30, metalness: 0.0, roughness: 0.8, side: THREE.DoubleSide });

flagConeGeo.clearGroups();
const radial = flagRadialSeg;
const trisPerHeightSeg = radial * 2;
const indicesPerHeightSeg = trisPerHeightSeg * 3;

for (let j = 0; j < geoLenSeg; j++) {
  const idxFromBigEnd = (geoLenSeg - 1 - j);
  const matIndex = (idxFromBigEnd % 2 === 0) ? 1 : 0;
  const start = j * indicesPerHeightSeg;
  flagConeGeo.addGroup(start, indicesPerHeightSeg, matIndex);
}

const flagCone = new THREE.Mesh(flagConeGeo, [flagMatWhite, flagMatRed]);
flagCone.rotation.z = -Math.PI / 2;
flagCone.position.set(flagLen * 0.5 + 1.1, 0, 0);
flagSockPivot.add(flagCone);

const flagBaseGeo = new THREE.CylinderGeometry(0.65, 0.85, 0.35, 18);
const flagBaseMat = new THREE.MeshStandardMaterial({ color: 0x2a2a2a, metalness: 0.05, roughness: 0.9 });
const flagBase = new THREE.Mesh(flagBaseGeo, flagBaseMat);
flagBase.position.y = 0.175;
flagGroup.add(flagBase);

flagGroup.position.set(-14, 0, 10);
scene.add(flagGroup);

// Physics
const g = 9.81;
const mass = 120;
const rho = 1.225;
const wingArea = 10.0;
const maxSpeed = 50.0;
const stallSpeed = 5.0;
const maxAngVel = Math.PI;
const inputDelay = 0.0;
const rampTime = 1.0;

const maxPitchRate = THREE.MathUtils.degToRad(90);
const maxYawRate   = THREE.MathUtils.degToRad(60);

const throttleRate = 0.55;
const maxThrust = 2200;
const baseDragExtra = 0.015;

const aoaLimitDeg = 18;
const aoaLimit = THREE.MathUtils.degToRad(aoaLimitDeg);

// State
let running = false;
let vel = new THREE.Vector3(0, 0, 0);
let throttle = 0.0;
let visible = true;

const camPos = new THREE.Vector3();
const camLook = new THREE.Vector3();

const keys = new Map();
const watched = new Set([
  'ShiftLeft','ShiftRight','ControlLeft','ControlRight',
  'KeyW','KeyS','KeyA','KeyD','KeyQ','KeyE',
  'KeyC'
]);

const ctrlAxes = {
  pitch: { cmd: 0, applied: 0, t: 0, delayedCmd: 0, delayLeft: 0 },
  yaw:   { cmd: 0, applied: 0, t: 0, delayedCmd: 0, delayLeft: 0 },
  roll:  { cmd: 0, applied: 0, t: 0, delayedCmd: 0, delayLeft: 0 }
};

function axisCmdFromKeys() {
  const pitch = (keys.get('KeyW') ? -1 : 0) + (keys.get('KeyS') ? 1 : 0);
  const yaw   = (keys.get('KeyD') ? -1 : 0) + (keys.get('KeyA') ? 1 : 0);
  const roll  = (keys.get('KeyE') ? 1 : 0) + (keys.get('KeyQ') ? -1 : 0);
  return { pitch: clamp(pitch, -1, 1), yaw: clamp(yaw, -1, 1), roll: clamp(roll, -1, 1) };
}

function setAxisCmd(axisName, newCmd) {
  const ax = ctrlAxes[axisName];
  if (ax.cmd !== newCmd) {
    ax.cmd = newCmd;
    ax.delayLeft = inputDelay;
    ax.t = 0;
    ax.delayedCmd = 0;
  }
}

function updateCtrlAxes(dt) {
  const desired = axisCmdFromKeys();
  setAxisCmd('pitch', desired.pitch);
  setAxisCmd('yaw', desired.yaw);
  setAxisCmd('roll', desired.roll);

  for (const name of ['pitch','yaw','roll']) {
    const ax = ctrlAxes[name];

    if (ax.delayLeft > 0) {
      ax.delayLeft -= dt;
      if (ax.delayLeft <= 0) {
        ax.delayedCmd = ax.cmd;
        ax.t = 0;
      }
    } else {
      ax.delayedCmd = ax.cmd;
    }

    ax.t += dt;
    const gain = easeInOut(ax.t / rampTime);
    const target = ax.delayedCmd * gain;

    const follow = 10.0;
    ax.applied = lerp(ax.applied, target, 1 - Math.exp(-follow * dt));
  }
}

const freeCam = {
  enabled: false,
  yaw: 0,
  pitch: 0,
  radius: 18,
  yOffset: 6,
  sens: 0.0022
};

function reset() {
  craft.position.set(0, 30, 0);
  craft.quaternion.identity();
  vel.set(0, 0, 0);
  throttle = 0.0;

  keys.clear();
  for (const k of Object.keys(ctrlAxes)) {
    ctrlAxes[k].cmd = 0;
    ctrlAxes[k].applied = 0;
    ctrlAxes[k].t = 0;
    ctrlAxes[k].delayedCmd = 0;
    ctrlAxes[k].delayLeft = 0;
  }

  freeCam.enabled = false;
  freeCam.yaw = 0;
  freeCam.pitch = 0;
  freeCam.radius = 18;
  freeCam.yOffset = 6;

  camPos.copy(craft.position).add(new THREE.Vector3(0, 6, -16));
  camLook.copy(craft.position).add(new THREE.Vector3(0, 2, 10));
  camera.position.copy(camPos);
  camera.lookAt(camLook);

  resetTrail();
}

const onKeyDown = (e) => {
  if (watched.has(e.code)) e.preventDefault();
  keys.set(e.code, true);
};
const onKeyUp = (e) => {
  if (watched.has(e.code)) e.preventDefault();
  keys.set(e.code, false);
};
window.addEventListener('keydown', onKeyDown, { passive: false });
window.addEventListener('keyup', onKeyUp, { passive: false });
window.addEventListener('blur', () => keys.clear());

async function tryPointerLock() {
  try { await renderer.domElement.requestPointerLock(); } catch {}
}
btnStart.addEventListener('click', async () => { await tryPointerLock(); running = true; });
btnRestart.addEventListener('click', async () => { await tryPointerLock(); reset(); running = true; });

function getWindVector() {
  const ws = Number(windSpeedEl.value);
  const wdDeg = Number(windDirEl.value);
  const wd = THREE.MathUtils.degToRad(wdDeg);

  const fromDir = new THREE.Vector3(Math.sin(wd), 0, Math.cos(wd)).normalize();
  const windVel = fromDir.clone().multiplyScalar(-ws);
  return { ws, wdDeg, wdRad: wd, fromDir, windVel };
}

function step(dt) {
  const shift = (keys.get('ShiftLeft') || keys.get('ShiftRight')) ? 1 : 0;
  const ctrl  = (keys.get('ControlLeft') || keys.get('ControlRight')) ? 1 : 0;
  throttle = clamp(throttle + (shift - ctrl) * throttleRate * dt, 0, 1);

  updateCtrlAxes(dt);

  const pitchRate = ctrlAxes.pitch.applied * maxPitchRate;
  const yawRate   = ctrlAxes.yaw.applied   * maxYawRate;
  const rollRate  = ctrlAxes.roll.applied  * maxAngVel;

  const qPitch = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0), -pitchRate * dt);
  const qYaw   = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),  yawRate * dt);
  const qRoll  = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),  rollRate * dt);

  const dq = new THREE.Quaternion().multiply(qYaw).multiply(qPitch).multiply(qRoll);
  craft.quaternion.multiply(dq).normalize();

  const forward = new THREE.Vector3(0, 0, 1).applyQuaternion(craft.quaternion).normalize();
  const right   = new THREE.Vector3(1, 0, 0).applyQuaternion(craft.quaternion).normalize();
  const up      = new THREE.Vector3(0, 1, 0).applyQuaternion(craft.quaternion).normalize();

  const wind = getWindVector();

  const airVel = vel.clone().sub(wind.windVel);
  const airSpeed = airVel.length();
  const vDir = airSpeed > 1e-4 ? airVel.clone().multiplyScalar(1 / airSpeed) : forward.clone();

  const thrust = forward.clone().multiplyScalar(throttle * maxThrust);
  const gravity = new THREE.Vector3(0, -mass * g, 0);

  const Cd = Number(dragEl.value) + baseDragExtra;
  const dragMag = 0.5 * rho * airSpeed * airSpeed * Cd * wingArea;
  const drag = airSpeed > 1e-4 ? vDir.clone().multiplyScalar(-dragMag) : new THREE.Vector3();

  const windExtraCoeff = 0.5 * rho * wingArea * 0.08;
  const windExtraMag = windExtraCoeff * airSpeed * airSpeed * (wind.ws / 10.0);
  const windExtraDrag = airSpeed > 1e-4 ? vDir.clone().multiplyScalar(-windExtraMag) : new THREE.Vector3();

  let liftDir = new THREE.Vector3().crossVectors(vDir, right);
  const ldl = liftDir.length();
  if (ldl < 1e-4) liftDir = up.clone();
  else liftDir.multiplyScalar(1 / ldl);

  const angleFV = Math.acos(clamp(forward.dot(vDir), -1, 1));
  const crossFV = new THREE.Vector3().crossVectors(forward, vDir);
  const aoaSign = Math.sign(crossFV.dot(right)) || 1;
  let aoa = angleFV * aoaSign;

  const slowFactor = clamp((15 - airSpeed) / 15, 0, 1);
  aoa *= (1.0 + 0.8 * slowFactor);
  aoa = clamp(aoa, -aoaLimit, aoaLimit);

  const ClBase = Number(liftEl.value);
  const aoaNorm = Math.abs(aoa) / aoaLimit;
  const stallSoft = clamp(1.0 - 0.55 * Math.pow(aoaNorm, 2.2), 0.25, 1.0);
  const Cl = ClBase * (aoa / aoaLimit) * 1.2 * stallSoft;

  const liftMag = 0.5 * rho * airSpeed * airSpeed * wingArea * Cl;
  const lift = liftDir.multiplyScalar(liftMag);

  if (airSpeed < stallSpeed) {
    const t = clamp((stallSpeed - airSpeed) / stallSpeed, 0, 1);
    const pitchDownRate = (0.35 * Math.PI) * t;
    const qDown = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0), pitchDownRate * dt);
    craft.quaternion.multiply(qDown).normalize();
  }

  const totalForce = new THREE.Vector3().add(thrust).add(gravity).add(drag).add(lift).add(windExtraDrag);
  const acc = totalForce.multiplyScalar(1 / mass);
  vel.add(acc.multiplyScalar(dt));

  const sp = vel.length();
  if (sp > maxSpeed) vel.multiplyScalar(maxSpeed / sp);

  craft.position.add(vel.clone().multiplyScalar(dt));

  if (craft.position.y < 2) {
    craft.position.y = 2;
    if (vel.y < 0) vel.y = 0;
  }

  hudThrottle.textContent = throttle.toFixed(2);
  hudSpeed.textContent = airSpeed.toFixed(1);
  hudAlt.textContent = craft.position.y.toFixed(1);
  hudAoA.textContent = rad2deg(aoa).toFixed(1);

  addTrailPoint(40);

  const yaw = Math.atan2(wind.fromDir.x, wind.fromDir.z);
  flagSockPivot.rotation.y = yaw;
}

const onMouseMove = (e) => {
  if (!freeCam.enabled) return;
  const dx = e.movementX ?? 0;
  const dy = e.movementY ?? 0;
  freeCam.yaw   += dx * freeCam.sens;
  freeCam.pitch -= dy * freeCam.sens;
  freeCam.pitch = clamp(freeCam.pitch, THREE.MathUtils.degToRad(-80), THREE.MathUtils.degToRad(80));
};
window.addEventListener('mousemove', onMouseMove, { passive: true });

function updateCamera(dt) {
  const forward = new THREE.Vector3(0, 0, 1).applyQuaternion(craft.quaternion).normalize();
  const up = new THREE.Vector3(0, 1, 0).applyQuaternion(craft.quaternion).normalize();
  const speed = vel.length();

  freeCam.enabled = !!keys.get('KeyC');

  if (freeCam.enabled) {
    const target = craft.position.clone().add(up.clone().multiplyScalar(freeCam.yOffset));

    const cy = Math.cos(freeCam.pitch);
    const sy = Math.sin(freeCam.pitch);
    const cx = Math.cos(freeCam.yaw);
    const sx = Math.sin(freeCam.yaw);

    const offset = new THREE.Vector3(
      sx * cy,
      sy,
      cx * cy
    ).multiplyScalar(freeCam.radius);

    const desiredPos = target.clone().add(offset);

    const follow = 10.0;
    camPos.lerp(desiredPos, 1 - Math.exp(-follow * dt));
    camLook.lerp(target, 1 - Math.exp(-follow * dt));

    camera.position.copy(camPos);
    camera.up.set(0, 1, 0);
    camera.lookAt(camLook);
    return;
  }

  const backDist = lerp(14, 22, clamp(speed / maxSpeed, 0, 1));
  const targetPos = craft.position.clone()
    .add(up.clone().multiplyScalar(6))
    .add(forward.clone().multiplyScalar(-backDist));

  const targetLook = craft.position.clone()
    .add(up.clone().multiplyScalar(2.0))
    .add(forward.clone().multiplyScalar(24.0));

  const follow = 6.0;
  camPos.lerp(targetPos, 1 - Math.exp(-follow * dt));
  camLook.lerp(targetLook, 1 - Math.exp(-follow * dt));

  camera.position.copy(camPos);
  camera.up.set(0, 1, 0);
  camera.lookAt(camLook);
}

let last = performance.now();
let rafId = 0;

function frame(now) {
  if(!visible){
    rafId = requestAnimationFrame(frame);
    return;
  }
  const dt = clamp((now - last) / 1000, 0, 0.033);
  last = now;

  if (running) step(dt);
  updateCamera(dt);
  renderer.render(scene, camera);

  rafId = requestAnimationFrame(frame);
}

function resize(){
  renderer.setSize(innerWidth, innerHeight);
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
}

function setVisible(v){
  visible = !!v;
  if(visible){
    last = performance.now();
  }
}

reset();
rafId = requestAnimationFrame(frame);

// expose minimal control API
window.__SIMULATOR_APP__ = {
  resize,
  setVisible,
  dispose(){
    try { cancelAnimationFrame(rafId); } catch {}
    window.removeEventListener('keydown', onKeyDown);
    window.removeEventListener('keyup', onKeyUp);
    window.removeEventListener('mousemove', onMouseMove);
    try { trailGeo.dispose(); trailMat.dispose(); } catch {}
    try { renderer.dispose(); renderer.domElement?.remove(); } catch {}
    window.__SIMULATOR_APP__ = null;
  }
};
`;
  const blob = new Blob([simCode], { type: 'text/javascript;charset=UTF-8' });
  const url = URL.createObjectURL(blob);

  // Provide the import target used by main script
  const moduleMap = new Map();
  moduleMap.set('./__simulator_module__.js', url);

  // Monkey patch dynamic import for our pseudo-module path (single-file requirement)
  const origImport = window.__dynamicImport__ || ((p) => import(p));
  window.__dynamicImport__ = (p) => {
    const mapped = moduleMap.get(p) || p;
    return import(mapped);
  };

  // Patch the earlier call site by defining a global import hook
  // Replace global import() is not possible; so we also expose a helper and use it via inline override below.
  // But the main script already calls import('./__simulator_module__.js') directly.
  // To keep it working, we define an import map-like behavior by creating a <script type="module"> that re-exports,
  // however browsers don't let us register a virtual module by name. So we instead set a global that triggers load here:
  window.addEventListener('load', () => {
    // nothing
  });

  // Workaround: define a real module script tag with src=blob URL and store it,
  // then when showSimulator() calls import('./__simulator_module__.js') it would fail.
  // Therefore, we also immediately attach the module by importing the blob URL and caching in global:
  // To meet your requested behavior (click enters simulator), we will lazy-init by evaluating only when requested:
  // We'll create a global loader that showSimulator() can call if present.
  window.__LOAD_SIMULATOR__ = async () => {
    if(window.__SIMULATOR_APP__) return window.__SIMULATOR_APP__;
    await import(url);
    return window.__SIMULATOR_APP__;
  };

  // Now patch showSimulator in main script (defined earlier) by replacing import() usage:
  // If main script already ran, we can override the click handler by rebinding navSimulator:
  const navSimulator = document.getElementById('navSimulator');
  const simulatorRoot = document.getElementById('simulatorRoot');
  const siteRoot = document.getElementById('siteRoot');
  const rightDock = document.getElementById('rightDock');
  const bg = document.getElementById('bg');

  function closeOverlayIfAny(){
    const overlay = document.getElementById('overlay');
    if(overlay && overlay.classList.contains('show')){
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      const sheetBody = document.getElementById('sheetBody');
      if(sheetBody) sheetBody.innerHTML = '';
    }
  }

  function showSimulatorPatched(){
    closeOverlayIfAny();
    siteRoot.style.display = 'none';
    rightDock.style.display = 'none';
    bg.style.display = 'none';

    simulatorRoot.classList.add('active');
    simulatorRoot.setAttribute('aria-hidden','false');

    window.__LOAD_SIMULATOR__().then(app => {
      if(app?.setVisible) app.setVisible(true);
      if(app?.resize) app.resize();
    }).catch(()=>{});
  }

  // Rebind to ensure it enters simulator
  if(navSimulator){
    navSimulator.addEventListener('click', (e) => {
      e.preventDefault();
      showSimulatorPatched();
    }, {capture:true});
  }

  // Back button ensures visibility toggles
  const back = document.getElementById('btnBackToSite');
  if(back){
    back.addEventListener('click', (e) => {
      e.preventDefault();
      simulatorRoot.classList.remove('active');
      simulatorRoot.setAttribute('aria-hidden','true');
      siteRoot.style.display = '';
      rightDock.style.display = '';
      bg.style.display = '';
      if(window.__SIMULATOR_APP__?.setVisible) window.__SIMULATOR_APP__.setVisible(false);
    }, {capture:true});
  }
</script>
</body>
</html>
